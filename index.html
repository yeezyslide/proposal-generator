<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      line-height: 1.5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
    }

    .settings-btn {
      background: transparent;
      border: 1px solid #333;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #999;
      transition: all 0.2s;
    }

    .settings-btn:hover { background: #1a1a1a; border-color: #444; color: #fff; }

    .card {
      background: #141414;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #fff;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #888;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 16px;
      background: #1a1a1a;
      color: #e5e5e5;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #fff;
    }

    input::placeholder, textarea::placeholder {
      color: #555;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    select {
      cursor: pointer;
    }

    .row {
      display: flex;
      gap: 16px;
    }

    .row > * { flex: 1; }

    .list-item {
      background: #1a1a1a;
      border: 1px solid #282828;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      position: relative;
    }

    .list-item .remove-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #555;
      cursor: pointer;
      font-size: 18px;
      transition: color 0.2s;
    }

    .list-item .remove-btn:hover { color: #ff4444; }

    .add-btn {
      background: transparent;
      border: 1px dashed #333;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      width: 100%;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .add-btn:hover { background: #1a1a1a; border-color: #444; color: #999; }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #fff;
      color: #000;
    }

    .btn-primary:hover { background: #e0e0e0; }

    .btn-secondary {
      background: #222;
      color: #e5e5e5;
      border: 1px solid #333;
    }

    .btn-secondary:hover { background: #2a2a2a; border-color: #444; }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .total-investment {
      font-size: 20px;
      font-weight: 600;
      text-align: right;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #333;
      color: #fff;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 100;
    }

    .modal-overlay.active { display: flex; align-items: center; justify-content: center; }

    .modal {
      background: #141414;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #fff;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .status.success { display: block; background: #0d2818; color: #4ade80; border: 1px solid #166534; }
    .status.error { display: block; background: #2d1215; color: #f87171; border: 1px solid #991b1b; }
    .status.loading { display: block; background: #2d2305; color: #fbbf24; border: 1px solid #854d0e; }

    .client-needs-list input {
      margin-bottom: 8px;
    }

    #email-content {
      background: #1a1a1a !important;
      border: 1px solid #282828;
      color: #e5e5e5;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #444;
    }

    /* Login screen */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-box {
      background: #141414;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-box h1 {
      margin-bottom: 8px;
      font-size: 24px;
    }

    .login-box p {
      color: #666;
      margin-bottom: 24px;
    }

    .login-box input {
      text-align: center;
      font-size: 18px;
      letter-spacing: 4px;
    }

    .login-error {
      color: #f87171;
      margin-bottom: 16px;
      display: none;
    }

    .app-content {
      display: none;
    }

    .app-content.visible {
      display: block;
    }

    /* Editor Styles */
    .editor-btn {
      background: #222;
      border: 1px solid #333;
      color: #e5e5e5;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .editor-btn:hover {
      background: #2a2a2a;
      border-color: #444;
    }

    #editor-content:focus {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }

    #editor-content h1 {
      color: #1a1a1a;
      font-size: 24px;
      font-weight: 600;
      margin-top: 0;
      margin-bottom: 12px;
    }

    #editor-content h2 {
      color: #1a1a1a;
      font-size: 17px;
      font-weight: 600;
      margin-top: 28px;
      margin-bottom: 12px;
    }

    #editor-content h3 {
      color: #34495e;
      font-size: 14px;
      font-weight: 600;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    #editor-content ul, #editor-content ol {
      padding-left: 20px;
      margin: 10px 0;
    }

    #editor-content li {
      margin: 6px 0;
    }

    #editor-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 16px 0;
      font-size: 12px;
    }

    #editor-content th, #editor-content td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
    }

    #editor-content th {
      background: #2c3e50;
      color: #fff;
      font-weight: 600;
    }

    #editor-content hr {
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 24px 0;
    }

    /* Contract Editor Styles */
    #contract-editor-content:focus {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }

    #contract-editor-content h1 {
      font-size: 18pt;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      color: #000;
    }

    #contract-editor-content h2 {
      font-size: 14pt;
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #000;
    }

    #contract-editor-content h3 {
      font-size: 12pt;
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 8px;
      color: #000;
    }

    #contract-editor-content p {
      margin: 10px 0;
      text-align: justify;
      color: #000;
    }

    #contract-editor-content ul, #contract-editor-content ol {
      margin-left: 20px;
      margin: 10px 0;
      padding-left: 20px;
    }

    #contract-editor-content li {
      margin: 6px 0;
    }

    #contract-editor-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
    }

    #contract-editor-content th, #contract-editor-content td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }

    #contract-editor-content th {
      background: #f0f0f0;
      font-weight: bold;
    }

    #contract-editor-content .signature-line {
      margin-top: 50px;
      border-top: 1px solid #000;
      padding-top: 5px;
      width: 300px;
    }

    /* Tab Styles */
    .tab-btn.active {
      color: #fff !important;
      border-bottom-color: #fff !important;
    }

    .tab-btn:hover {
      color: #ccc !important;
    }

    .tab-content {
      display: block;
    }

    .tab-content.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h1>Proposal Generator</h1>
      <p>Enter password to continue</p>
      <div class="login-error" id="loginError">Invalid password</div>
      <input type="password" id="passwordInput" placeholder="Password" autofocus>
      <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 16px;">
        Enter
      </button>
    </div>
  </div>

  <div class="app-content" id="appContent">
  <div class="container">
    <header>
      <h1>Proposal Generator</h1>
      <button class="settings-btn" onclick="openSettings()">Settings</button>
    </header>

    <!-- Tabs -->
    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #222;">
      <button class="tab-btn active" id="proposal-tab" onclick="switchTab('proposal')" style="background: transparent; border: none; padding: 12px 20px; color: #999; cursor: pointer; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; transition: all 0.2s;">
        Proposal
      </button>
      <button class="tab-btn" id="contract-tab" onclick="switchTab('contract')" style="background: transparent; border: none; padding: 12px 20px; color: #999; cursor: pointer; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; transition: all 0.2s;">
        Contract Agreement
      </button>
      <button class="tab-btn" id="invoice-tab" onclick="switchTab('invoice')" style="background: transparent; border: none; padding: 12px 20px; color: #999; cursor: pointer; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; transition: all 0.2s;">
        Invoice
      </button>
      <button class="tab-btn" id="project-md-tab" onclick="switchTab('project-md')" style="background: transparent; border: none; padding: 12px 20px; color: #999; cursor: pointer; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; transition: all 0.2s;">
        Project MD File
      </button>
    </div>

    <div id="status" class="status"></div>

    <!-- Proposal Tab Content -->
    <div id="proposal-content" class="tab-content">

    <!-- Client Info -->
    <div class="card">
      <h2>Client Information</h2>
      <div class="row">
        <div>
          <label>Client / Company Name</label>
          <input type="text" id="client_name" placeholder="Acme Corp">
        </div>
        <div>
          <label>Proposal Name</label>
          <input type="text" id="proposal_name" placeholder="Website Redesign">
        </div>
      </div>
    </div>

    <!-- Transcript -->
    <div class="card">
      <h2>Meeting Transcript</h2>
      <label>Paste your transcript or meeting notes</label>
      <textarea id="transcript" placeholder="Paste the meeting transcript here..."></textarea>
      <label>Additional Notes (optional)</label>
      <textarea id="notes" style="min-height: 80px;" placeholder="Any extra context..."></textarea>
      <button class="btn btn-secondary" onclick="analyzeTranscript()" id="analyzeBtn">
        Analyze with AI
      </button>
    </div>

    <!-- Project Summary -->
    <div class="card">
      <h2>Project Summary</h2>
      <textarea id="project_summary" style="min-height: 150px;" placeholder="This will be auto-generated from your transcript, or you can write it manually..."></textarea>
    </div>

    <!-- Deliverables -->
    <div class="card">
      <h2>Deliverables</h2>
      <div id="deliverables-list"></div>
      <button class="add-btn" onclick="addDeliverable()">+ Add Deliverable</button>
    </div>

    <!-- Timeline -->
    <div class="card">
      <h2>Project Timeline</h2>
      <div id="timeline-list"></div>
      <button class="add-btn" onclick="addTimelinePhase()">+ Add Phase</button>
      <div class="total-investment" style="border-top: 1px solid #ddd;">
        Total Duration: <span id="timeline-total">0 days</span>
      </div>
    </div>

    <!-- Client Needs -->
    <div class="card">
      <h2>What We Need From Client</h2>
      <div id="client-needs-list" class="client-needs-list"></div>
      <button class="add-btn" onclick="addClientNeed()">+ Add Item</button>
    </div>

    <!-- Payment Milestones -->
    <div class="card">
      <h2>Payment Milestones</h2>
      <div id="milestones-list"></div>
      <button class="add-btn" onclick="addMilestone()">+ Add Milestone</button>
      <div class="total-investment">
        Total: $<span id="total-investment">0</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-primary" onclick="showEditor()" id="previewBtn">
        Preview & Edit
      </button>
      <button class="btn btn-primary" onclick="generatePdf()" id="generateBtn" style="display: none;">
        Generate PDF
      </button>
      <button class="btn btn-secondary" onclick="generateEmail()">
        Generate Email
      </button>
      <button class="btn btn-secondary" onclick="clearForm()">
        Clear All
      </button>
    </div>

    <!-- Visual Editor Preview -->
    <div class="card" id="editor-card" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Preview & Edit Proposal</h2>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" onclick="hideEditor()" style="padding: 8px 16px;">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="generatePdfFromEditor()" style="padding: 8px 16px;">
            Generate PDF
          </button>
        </div>
      </div>
      
      <!-- Formatting Toolbar -->
      <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 8px; margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="editor-btn" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
        <button class="editor-btn" onclick="formatText('italic')" title="Italic"><em>I</em></button>
        <button class="editor-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="editor-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">• List</button>
        <button class="editor-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="editor-btn" onclick="formatText('formatBlock', 'h2')" title="Heading 2">H2</button>
        <button class="editor-btn" onclick="formatText('formatBlock', 'h3')" title="Heading 3">H3</button>
        <button class="editor-btn" onclick="formatText('formatBlock', 'p')" title="Paragraph">P</button>
      </div>
      
      <!-- Editable Content Area -->
      <div id="editor-content" contenteditable="true" style="
        background: #fff;
        color: #2c3e50;
        padding: 24px;
        border: 1px solid #333;
        border-radius: 6px;
        min-height: 600px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        font-size: 13px;
        line-height: 1.5;
        overflow-y: auto;
        max-height: 80vh;
      "></div>
    </div>

    <!-- Email Preview -->
    <div class="card" id="email-card" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Email Draft</h2>
        <button class="btn btn-primary" onclick="copyEmail()" style="padding: 8px 16px;">
          Copy to Clipboard
        </button>
      </div>
      <div id="email-content" style="background: #f9f9f9; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: inherit; line-height: 1.6;"></div>
    </div>
    </div>

    <!-- Contract Agreement Tab Content -->
    <div id="contract-content" class="tab-content" style="display: none;">
      <!-- Contract Client Info -->
      <div class="card">
        <h2>Contract Information</h2>
        <div class="row">
          <div>
            <label>Client Name / Company</label>
            <input type="text" id="contract_client_name" placeholder="John Doe / Acme Corp">
          </div>
          <div>
            <label>Client Email</label>
            <input type="email" id="contract_client_email" placeholder="client@example.com">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Client Address</label>
            <input type="text" id="contract_client_address" placeholder="123 Main St, City, State ZIP">
          </div>
          <div>
            <label>Agreement Date</label>
            <input type="date" id="contract_date" value="">
          </div>
        </div>
      </div>

      <!-- Project Details -->
      <div class="card">
        <h2>Project Details</h2>
        <label>Project Name / Description</label>
        <input type="text" id="contract_project_name" placeholder="Website Redesign">
        <label>Project Scope / Deliverables</label>
        <textarea id="contract_scope" style="min-height: 120px;" placeholder="Detailed description of work to be performed..."></textarea>
        <label>Project Timeline / Completion Date</label>
        <input type="text" id="contract_timeline" placeholder="e.g., 6 weeks from start date, or specific date">
      </div>

      <!-- Payment Terms -->
      <div class="card">
        <h2>Payment Terms</h2>
        <label>Total Project Fee</label>
        <input type="number" id="contract_total_fee" placeholder="5000" min="0" step="0.01">
        <label>Payment Schedule (e.g., "50% upon signing, 50% upon completion")</label>
        <textarea id="contract_payment_schedule" style="min-height: 80px;" placeholder="Describe payment milestones and amounts..."></textarea>
      </div>

      <!-- Additional Terms -->
      <div class="card">
        <h2>Additional Terms</h2>
        <label>
          <input type="checkbox" id="contract_work_sharing" checked style="width: auto; margin-right: 8px;">
          Client agrees to work sharing on social media (with attribution)
        </label>
        <label>
          <input type="checkbox" id="contract_confidentiality" checked style="width: auto; margin-right: 8px;">
          Maintain strict confidentiality of client information
        </label>
        <label>Additional Terms or Modifications (optional)</label>
        <textarea id="contract_additional_terms" style="min-height: 100px;" placeholder="Any additional terms or modifications to the standard agreement..."></textarea>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-primary" onclick="showContractEditor()" id="previewContractBtn">
          Preview & Edit
        </button>
        <button class="btn btn-primary" onclick="generateContract()" id="generateContractBtn" style="display: none;">
          Generate Contract
        </button>
        <button class="btn btn-secondary" onclick="clearContractForm()">
          Clear Form
        </button>
      </div>

      <!-- Contract Visual Editor Preview -->
      <div class="card" id="contract-editor-card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Preview & Edit Contract Agreement</h2>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="hideContractEditor()" style="padding: 8px 16px;">
              Cancel
            </button>
            <button class="btn btn-primary" onclick="generateContractFromEditor()" style="padding: 8px 16px;">
              Generate Contract
            </button>
          </div>
        </div>
        
        <!-- Formatting Toolbar -->
        <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 8px; margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="editor-btn" onclick="formatContractText('bold')" title="Bold"><strong>B</strong></button>
          <button class="editor-btn" onclick="formatContractText('italic')" title="Italic"><em>I</em></button>
          <button class="editor-btn" onclick="formatContractText('underline')" title="Underline"><u>U</u></button>
          <div style="width: 1px; background: #333; margin: 0 4px;"></div>
          <button class="editor-btn" onclick="formatContractText('insertUnorderedList')" title="Bullet List">• List</button>
          <button class="editor-btn" onclick="formatContractText('insertOrderedList')" title="Numbered List">1. List</button>
          <div style="width: 1px; background: #333; margin: 0 4px;"></div>
          <button class="editor-btn" onclick="formatContractText('formatBlock', 'h1')" title="Heading 1">H1</button>
          <button class="editor-btn" onclick="formatContractText('formatBlock', 'h2')" title="Heading 2">H2</button>
          <button class="editor-btn" onclick="formatContractText('formatBlock', 'p')" title="Paragraph">P</button>
        </div>
        
        <!-- Editable Contract Content Area -->
        <div id="contract-editor-content" contenteditable="true" style="
          background: #fff;
          color: #000;
          padding: 40px;
          border: 1px solid #333;
          border-radius: 6px;
          min-height: 800px;
          font-family: 'Times New Roman', Times, serif;
          font-size: 12pt;
          line-height: 1.6;
          overflow-y: auto;
          max-height: 85vh;
        "></div>
      </div>
    </div>
  </div>
  </div>

    <!-- Invoice Tab Content -->
    <div id="invoice-content" class="tab-content" style="display: none;">
      <!-- Invoice Header Info -->
      <div class="card">
        <h2>Invoice Information</h2>
        <div class="row">
          <div class="col">
            <label>Invoice Number</label>
            <input type="text" id="invoice_number" placeholder="INV-001">
          </div>
          <div class="col">
            <label>Invoice Date</label>
            <input type="date" id="invoice_date">
          </div>
          <div class="col">
            <label>Due Date</label>
            <input type="date" id="invoice_due_date">
          </div>
        </div>
      </div>

      <!-- Bill From Information -->
      <div class="card">
        <h2>Bill From</h2>
        <div class="row">
          <div class="col">
            <label>Business Name / LLC</label>
            <input type="text" id="invoice_bill_from_name" placeholder="Leave empty to use settings default">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Email</label>
            <input type="email" id="invoice_bill_from_email" placeholder="Leave empty to use settings default">
          </div>
          <div class="col">
            <label>Phone</label>
            <input type="text" id="invoice_bill_from_phone" placeholder="Leave empty to use settings default">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Address (Optional)</label>
            <textarea id="invoice_bill_from_address" rows="2" placeholder="Street Address, City, State ZIP (optional)"></textarea>
          </div>
        </div>
      </div>

      <!-- Client Information -->
      <div class="card">
        <h2>Bill To</h2>
        <div class="row">
          <div class="col">
            <label>Client Name</label>
            <input type="text" id="invoice_client_name" placeholder="Client Company Name">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Client Email</label>
            <input type="email" id="invoice_client_email" placeholder="client@example.com">
          </div>
          <div class="col">
            <label>Client Address</label>
            <textarea id="invoice_client_address" rows="3" placeholder="Street Address, City, State ZIP"></textarea>
          </div>
        </div>
      </div>

      <!-- Line Items -->
      <div class="card">
        <h2>Line Items</h2>
        <div id="invoice-items-list"></div>
        <button class="add-btn" onclick="addInvoiceItem()">+ Add Item</button>
        <div class="total-investment" style="border-top: 1px solid #ddd; margin-top: 16px; padding-top: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <strong>Subtotal:</strong>
            <span>$<span id="invoice_subtotal">0.00</span></span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <label style="margin: 0; display: flex; align-items: center; gap: 8px;">
              Tax Rate (%):
              <input type="number" id="invoice_tax_rate" step="0.01" min="0" max="100" value="0" style="width: 80px; padding: 4px 8px;" oninput="calculateInvoiceTotal()">
            </label>
            <span>$<span id="invoice_tax">0.00</span></span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; border-top: 2px solid #1a1a1a; padding-top: 8px; margin-top: 8px;">
            <strong>Total:</strong>
            <span>$<span id="invoice_total">0.00</span></span>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="card">
        <h2>Notes</h2>
        <div class="row">
          <div class="col">
            <label>Additional Information</label>
            <textarea id="invoice_notes" rows="4" placeholder="Payment instructions, thank you message, etc."></textarea>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-primary" onclick="generateInvoice()">
          Generate Invoice PDF
        </button>
        <button class="btn btn-secondary" onclick="clearInvoiceForm()">
          Clear All
        </button>
      </div>
    </div>

    <!-- Project MD File Tab Content -->
    <div id="project-md-content" class="tab-content" style="display: none;">
      <!-- Project Information -->
      <div class="card">
        <h2>Project Information</h2>
        <div class="row">
          <div class="col">
            <label>Project Name</label>
            <input type="text" id="project_md_name" placeholder="Website Redesign for Acme Corp">
          </div>
          <div class="col">
            <label>Project Niche / Industry</label>
            <input type="text" id="project_md_niche" placeholder="SaaS, E-commerce, Healthcare, etc.">
          </div>
        </div>
      </div>

      <!-- Company Details -->
      <div class="card">
        <h2>Company Details</h2>
        <div class="row">
          <div class="col">
            <label>Company Name</label>
            <input type="text" id="project_md_company_name" placeholder="Acme Corporation">
          </div>
          <div class="col">
            <label>Industry / Sector</label>
            <input type="text" id="project_md_industry" placeholder="Technology, Retail, etc.">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Company Description</label>
            <textarea id="project_md_company_description" rows="3" placeholder="Brief description of what the company does..."></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Target Audience</label>
            <textarea id="project_md_target_audience" rows="2" placeholder="Who are the target users/customers?"></textarea>
          </div>
        </div>
      </div>

      <!-- Client Conversation -->
      <div class="card">
        <h2>Client Conversation / Requirements</h2>
        <div class="row">
          <div class="col">
            <label>Paste conversation between client</label>
            <textarea id="project_md_conversation" rows="12" placeholder="Paste emails, Slack messages, meeting notes, or any conversation with the client about the project..."></textarea>
          </div>
        </div>
      </div>

      <!-- Reference Sites -->
      <div class="card">
        <h2>Reference Site Links</h2>
        <div class="row">
          <div class="col">
            <label>Website URL (if existing)</label>
            <input type="url" id="project_md_website_url" placeholder="https://example.com">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Reference Sites / Inspiration (one per line)</label>
            <textarea id="project_md_reference_links" rows="6" placeholder="https://reference-site-1.com&#10;https://reference-site-2.com&#10;https://inspiration-example.com"></textarea>
          </div>
        </div>
      </div>

      <!-- Additional Project Details -->
      <div class="card">
        <h2>Additional Project Details</h2>
        <div class="row">
          <div class="col">
            <label>Project Goals / Objectives</label>
            <textarea id="project_md_goals" rows="4" placeholder="What are the main goals for this project? What problems are we solving?"></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Key Requirements / Deliverables</label>
            <textarea id="project_md_requirements" rows="4" placeholder="List key features, deliverables, and requirements..."></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Technology Stack (Optional)</label>
            <input type="text" id="project_md_tech_stack" placeholder="React, Next.js, Shopify, WordPress, etc.">
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Timeline / Important Dates (Optional)</label>
            <textarea id="project_md_timeline" rows="2" placeholder="Launch date, milestone dates, etc."></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Additional Notes</label>
            <textarea id="project_md_notes" rows="4" placeholder="Any other relevant information about the project..."></textarea>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-primary" onclick="generateProjectMD()">
          Generate Markdown File
        </button>
        <button class="btn btn-secondary" onclick="clearProjectMDForm()">
          Clear All
        </button>
      </div>
    </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>Settings</h2>
      <label>Business Name</label>
      <input type="text" id="settings_business_name" placeholder="Your Design Studio">
      <label>Email</label>
      <input type="email" id="settings_business_email" placeholder="hello@example.com">
      <label>Phone</label>
      <input type="text" id="settings_business_phone" placeholder="(555) 123-4567">
      <h3 style="margin-top: 20px; margin-bottom: 12px; color: #fff; font-size: 16px;">Bank Transfer Details</h3>
      <label>Bank Name</label>
      <input type="text" id="settings_bank_name" placeholder="JP Morgan Chase">
      <label>Account Number</label>
      <input type="text" id="settings_bank_account" placeholder="687043015">
      <label>Routing Number (Wire Transfer)</label>
      <input type="text" id="settings_bank_routing" placeholder="044000037">
      <label>Account Name</label>
      <input type="text" id="settings_bank_account_name" placeholder="MMP Capital LLC">
      <label>Account Address</label>
      <textarea id="settings_bank_address" rows="2" placeholder="Street Address, City, State ZIP"></textarea>
      <label>Studio Logo</label>
      <input type="file" id="settings_logo" accept="image/*" style="margin-bottom: 12px;">
      <div id="logo-preview" style="margin-bottom: 12px;"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <script>
    let settings = {};
    let authToken = localStorage.getItem('authToken') || '';

    // Auth functions
    async function login() {
      const password = document.getElementById('passwordInput').value;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (data.success) {
          authToken = data.token;
          localStorage.setItem('authToken', authToken);
          showApp();
        } else {
          document.getElementById('loginError').style.display = 'block';
        }
      } catch (e) {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContent').classList.add('visible');
      loadSettings();
    }

    async function checkAuth() {
      if (!authToken) return false;
      try {
        const res = await fetch('/api/auth-check', {
          headers: { 'X-Auth-Token': authToken }
        });
        const data = await res.json();
        return data.authenticated;
      } catch (e) {
        return false;
      }
    }

    // Helper for authenticated fetch
    function authFetch(url, options = {}) {
      options.headers = options.headers || {};
      options.headers['X-Auth-Token'] = authToken;
      return fetch(url, options);
    }

    // Enter key to submit password
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });

    // Check auth on page load
    checkAuth().then(isAuth => {
      if (isAuth) {
        showApp();
      }
    });

    // Load settings from localStorage
    async function loadSettings() {
      try {
        const stored = localStorage.getItem('proposalSettings');
        if (stored) {
          settings = JSON.parse(stored);
        }
        document.getElementById('settings_business_name').value = settings.business_name || '';
        document.getElementById('settings_business_email').value = settings.business_email || '';
        document.getElementById('settings_business_phone').value = settings.business_phone || '';
        
        // Load bank details with defaults
        document.getElementById('settings_bank_name').value = settings.bank_name || 'JP Morgan Chase';
        document.getElementById('settings_bank_account').value = settings.bank_account || '687043015';
        document.getElementById('settings_bank_routing').value = settings.bank_routing || '044000037';
        document.getElementById('settings_bank_account_name').value = settings.bank_account_name || 'MMP Capital LLC';
        document.getElementById('settings_bank_address').value = settings.bank_address || '40638 Grenata Preserve Place, Leesburg Virginia 20175 United States';
        
        // Show logo preview if exists
        if (settings.logo_base64) {
          showLogoPreview(settings.logo_base64);
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }

    function showLogoPreview(base64) {
      const preview = document.getElementById('logo-preview');
      preview.innerHTML = `<img src="${base64}" style="max-width: 200px; max-height: 100px; border: 1px solid #333; border-radius: 4px;">`;
    }

    function openSettings() {
      document.getElementById('settingsModal').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    async function saveSettings() {
      const logoFile = document.getElementById('settings_logo').files[0];
      
      // Convert logo to base64 if uploaded
      if (logoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          settings = {
            business_name: document.getElementById('settings_business_name').value,
            business_email: document.getElementById('settings_business_email').value,
            business_phone: document.getElementById('settings_business_phone').value,
            bank_name: document.getElementById('settings_bank_name').value,
            bank_account: document.getElementById('settings_bank_account').value,
            bank_routing: document.getElementById('settings_bank_routing').value,
            bank_account_name: document.getElementById('settings_bank_account_name').value,
            bank_address: document.getElementById('settings_bank_address').value,
            logo_base64: e.target.result
          };
          localStorage.setItem('proposalSettings', JSON.stringify(settings));
          closeSettings();
          showStatus('Settings saved!', 'success');
        };
        reader.readAsDataURL(logoFile);
      } else {
        settings = {
          business_name: document.getElementById('settings_business_name').value,
          business_email: document.getElementById('settings_business_email').value,
          business_phone: document.getElementById('settings_business_phone').value,
          bank_name: document.getElementById('settings_bank_name').value,
          bank_account: document.getElementById('settings_bank_account').value,
          bank_routing: document.getElementById('settings_bank_routing').value,
          bank_account_name: document.getElementById('settings_bank_account_name').value,
          bank_address: document.getElementById('settings_bank_address').value,
          logo_base64: settings.logo_base64 // Keep existing logo
        };
        localStorage.setItem('proposalSettings', JSON.stringify(settings));
        closeSettings();
        showStatus('Settings saved!', 'success');
      }
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      if (type !== 'loading') {
        setTimeout(() => { status.className = 'status'; }, 3000);
      }
    }

    // Deliverables
    function addDeliverable(name = '', description = '') {
      const list = document.getElementById('deliverables-list');
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <button class="remove-btn" onclick="this.parentElement.remove()">&times;</button>
        <label>Name</label>
        <input type="text" class="deliverable-name" value="${escapeHtml(name)}" placeholder="Homepage Design">
        <label>Description</label>
        <textarea class="deliverable-desc" placeholder="What this includes...">${escapeHtml(description)}</textarea>
      `;
      list.appendChild(item);
    }

    // Timeline
    function addTimelinePhase(phase = '', durationNum = '', durationUnit = 'weeks', description = '') {
      // Parse duration if it's a string like "2 weeks"
      if (typeof durationNum === 'string' && durationNum.includes(' ')) {
        const match = durationNum.match(/(\d+)\s*(day|days|week|weeks)/i);
        if (match) {
          durationNum = match[1];
          durationUnit = match[2].toLowerCase().startsWith('day') ? 'days' : 'weeks';
        }
      }

      const list = document.getElementById('timeline-list');
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <button class="remove-btn" onclick="this.parentElement.remove(); updateTimelineTotal()">&times;</button>
        <div class="row">
          <div style="flex: 2;">
            <label>Phase</label>
            <input type="text" class="phase-name" value="${escapeHtml(phase)}" placeholder="Design">
          </div>
          <div style="flex: 1;">
            <label>Duration</label>
            <input type="number" class="phase-duration-num" value="${escapeHtml(String(durationNum))}" placeholder="2" min="1" oninput="updateTimelineTotal()">
          </div>
          <div style="flex: 1;">
            <label>Unit</label>
            <select class="phase-duration-unit" onchange="updateTimelineTotal()">
              <option value="days" ${durationUnit === 'days' ? 'selected' : ''}>Days</option>
              <option value="weeks" ${durationUnit === 'weeks' ? 'selected' : ''}>Weeks</option>
            </select>
          </div>
        </div>
        <label>Description</label>
        <input type="text" class="phase-desc" value="${escapeHtml(description)}" placeholder="What happens in this phase">
      `;
      list.appendChild(item);
      updateTimelineTotal();
    }

    function updateTimelineTotal() {
      let totalDays = 0;
      document.querySelectorAll('#timeline-list .list-item').forEach(item => {
        const num = parseFloat(item.querySelector('.phase-duration-num').value) || 0;
        const unit = item.querySelector('.phase-duration-unit').value;
        if (unit === 'weeks') {
          totalDays += num * 7; // 7 days per week
        } else {
          totalDays += num;
        }
      });

      // Convert to weeks and days
      const weeks = Math.floor(totalDays / 7);
      const days = totalDays % 7;

      let totalText = '';
      if (weeks > 0 && days > 0) {
        totalText = `${weeks} week${weeks !== 1 ? 's' : ''}, ${days} day${days !== 1 ? 's' : ''}`;
      } else if (weeks > 0) {
        totalText = `${weeks} week${weeks !== 1 ? 's' : ''}`;
      } else if (days > 0) {
        totalText = `${days} day${days !== 1 ? 's' : ''}`;
      } else {
        totalText = '0 days';
      }

      document.getElementById('timeline-total').textContent = totalText;
    }

    // Client Needs
    function addClientNeed(need = '') {
      const list = document.getElementById('client-needs-list');
      const item = document.createElement('div');
      item.className = 'list-item';
      item.style.padding = '8px 40px 8px 12px';
      item.innerHTML = `
        <button class="remove-btn" onclick="this.parentElement.remove()">&times;</button>
        <input type="text" class="client-need" value="${escapeHtml(need)}" placeholder="Brand guidelines, logo files, etc." style="margin-bottom: 0;">
      `;
      list.appendChild(item);
    }

    // Milestones
    function addMilestone(name = '', amount = '') {
      const list = document.getElementById('milestones-list');
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <button class="remove-btn" onclick="this.parentElement.remove(); updateTotal()">&times;</button>
        <div class="row">
          <div style="flex: 2;">
            <label>Milestone</label>
            <input type="text" class="milestone-name" value="${escapeHtml(name)}" placeholder="Upon agreement">
          </div>
          <div style="flex: 1;">
            <label>Amount ($)</label>
            <input type="number" class="milestone-amount" value="${amount}" placeholder="1500" oninput="updateTotal()">
          </div>
        </div>
      `;
      list.appendChild(item);
      updateTotal();
    }

    function updateTotal() {
      const amounts = document.querySelectorAll('.milestone-amount');
      let total = 0;
      amounts.forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      document.getElementById('total-investment').textContent = total.toLocaleString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Analyze with AI
    async function analyzeTranscript() {
      const transcript = document.getElementById('transcript').value;
      const notes = document.getElementById('notes').value;

      if (!transcript.trim()) {
        showStatus('Please enter a transcript first', 'error');
        return;
      }

      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      btn.textContent = 'Analyzing...';
      showStatus('Analyzing transcript with AI...', 'loading');

      try {
        const res = await authFetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript, notes })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Analysis failed');
        }

        const data = await res.json();

        // Populate form
        document.getElementById('client_name').value = data.client_name || '';
        document.getElementById('project_summary').value = data.project_summary || '';

        // Clear and populate deliverables
        document.getElementById('deliverables-list').innerHTML = '';
        (data.deliverables || []).forEach(d => addDeliverable(d.name, d.description));

        // Clear and populate timeline
        document.getElementById('timeline-list').innerHTML = '';
        (data.timeline || []).forEach(t => addTimelinePhase(t.phase, t.duration, 'weeks', t.description));

        // Clear and populate client needs
        document.getElementById('client-needs-list').innerHTML = '';
        (data.client_needs || []).forEach(n => addClientNeed(n));

        showStatus('Analysis complete! Review and edit as needed.', 'success');
      } catch (e) {
        showStatus('Error: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Analyze with AI';
      }
    }

    // Visual Editor Functions
    function formatText(command, value = null) {
      document.execCommand(command, false, value);
      document.getElementById('editor-content').focus();
    }

    function showEditor() {
      const editorCard = document.getElementById('editor-card');
      const previewBtn = document.getElementById('previewBtn');
      const generateBtn = document.getElementById('generateBtn');
      
      // Generate HTML from form data
      const html = generateProposalHtml();
      
      // Populate editor
      document.getElementById('editor-content').innerHTML = html;
      
      // Show editor, hide preview button, show generate button
      editorCard.style.display = 'block';
      previewBtn.style.display = 'none';
      generateBtn.style.display = 'inline-block';
      
      // Scroll to editor
      editorCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function hideEditor() {
      const editorCard = document.getElementById('editor-card');
      const previewBtn = document.getElementById('previewBtn');
      const generateBtn = document.getElementById('generateBtn');
      
      editorCard.style.display = 'none';
      previewBtn.style.display = 'inline-block';
      generateBtn.style.display = 'none';
    }

    // Extract HTML generation to reusable function
    function generateProposalHtml() {
      const clientName = document.getElementById('client_name').value || 'Client';
      const proposalName = document.getElementById('proposal_name').value || 'Proposal';
      const projectSummary = document.getElementById('project_summary').value || '';
      const timelineTotal = document.getElementById('timeline-total').textContent;

      // Gather all data (same as before)
      const deliverables = [];
      document.querySelectorAll('#deliverables-list .list-item').forEach(item => {
        const name = item.querySelector('.deliverable-name').value;
        const desc = item.querySelector('.deliverable-desc').value;
        if (name) deliverables.push({ name, description: desc });
      });

      const timeline = [];
      document.querySelectorAll('#timeline-list .list-item').forEach(item => {
        const phase = item.querySelector('.phase-name').value;
        const num = item.querySelector('.phase-duration-num').value;
        const unit = item.querySelector('.phase-duration-unit').value;
        const desc = item.querySelector('.phase-desc').value;
        if (phase) timeline.push({ phase, duration: `${num} ${unit}`, description: desc });
      });

      const clientNeeds = [];
      document.querySelectorAll('#client-needs-list .client-need').forEach(input => {
        if (input.value.trim()) clientNeeds.push(input.value);
      });

      const milestones = [];
      let totalInvestment = 0;
      document.querySelectorAll('#milestones-list .list-item').forEach(item => {
        const name = item.querySelector('.milestone-name').value;
        const amount = parseFloat(item.querySelector('.milestone-amount').value) || 0;
        if (name) milestones.push({ name, amount });
        totalInvestment += amount;
      });

      const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

      // Build HTML (same logic as generatePdf but without window.open)
      let logoHtml = '';
      if (settings.logo_base64) {
        logoHtml = `<img src="${settings.logo_base64}" style="max-width: 160px; max-height: 70px; object-fit: contain; display: block;">`;
      }
      
      // Helper function for bullet lists
      function formatBulletList(text) {
        if (!text) return '';
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length === 0) return '';
        const hasBullets = lines.some(line => /^\s*[-•*]\s/.test(line));
        if (!hasBullets) {
          return escapeHtml(text).replace(/\n/g, '<br>');
        }
        const items = lines.map(line => {
          const match = line.match(/^(\s*)([-•*])\s+(.+)$/);
          if (!match) return null;
          const [, indent, , content] = match;
          return {
            level: Math.floor(indent.length / 2),
            content: content.trim()
          };
        }).filter(item => item !== null);
        if (items.length === 0) return escapeHtml(text).replace(/\n/g, '<br>');
        let html = '<ul style="margin: 10px 0; padding-left: 20px; list-style-type: disc;">';
        const stack = [{ level: 0, isListItem: false }];
        items.forEach((item, index) => {
          const { level, content } = item;
          const prevItem = index > 0 ? items[index - 1] : null;
          while (stack.length > 1 && stack[stack.length - 1].level >= level) {
            const top = stack[stack.length - 1];
            if (top.isListItem) {
              html += '</li>';
              stack.pop();
            }
            if (stack.length > 1 && stack[stack.length - 1].level >= level) {
              html += '</ul>';
              stack.pop();
            }
          }
          if (prevItem && level > prevItem.level) {
            html += '<ul style="margin: 6px 0; padding-left: 24px; list-style-type: circle;">';
            stack.push({ level, isListItem: false });
          }
          const fontSize = level > 0 ? '12px' : '13px';
          const margin = level > 0 ? '4px' : '6px';
          html += `<li style="margin: ${margin} 0; font-size: ${fontSize};">${escapeHtml(content)}`;
          stack.push({ level, isListItem: true });
          const nextItem = items[index + 1];
          if (!nextItem || nextItem.level <= level) {
            html += '</li>';
            stack.pop();
          }
        });
        while (stack.length > 1) {
          const top = stack.pop();
          if (top.isListItem) {
            html += '</li>';
          } else {
            html += '</ul>';
          }
        }
        html += '</ul>';
        return html;
      }
      
      let html = `
        <div style="margin-bottom:25px;border-bottom:1px solid #e0e0e0;padding-bottom:15px;">
          ${logoHtml}
        </div>
        <h1 style="color:#1a1a1a;border-bottom:none;padding-bottom:8px;margin-top:0;font-size:24px;font-weight:600;letter-spacing:-0.5px;">Web Design Proposal</h1>
        <p style="font-size:13px;"><strong style="color:#1a1a1a;font-weight:600;">Client:</strong> ${clientName}<br>
        <strong style="color:#1a1a1a;font-weight:600;">Date:</strong> ${date}<br>
        <strong style="color:#1a1a1a;font-weight:600;">From:</strong> Wenlaunch Studios</p>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

        <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Project Summary</h2>
        <p style="font-size:13px;line-height:1.5;color:#2c3e50;white-space:pre-wrap;">${escapeHtml(projectSummary || '').replace(/\n/g, '<br>')}</p>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

        <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Deliverables</h2>
      `;

      deliverables.forEach(d => {
        const formattedDesc = formatBulletList(d.description || '');
        html += `<h3 style="color:#34495e;font-size:14px;font-weight:600;margin-top:16px;margin-bottom:8px;">${escapeHtml(d.name)}</h3><div style="font-size:13px;line-height:1.5;color:#2c3e50;">${formattedDesc}</div>`;
      });

      html += `
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">
        <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Project Timeline</h2>
        <table style="border-collapse:collapse;width:100%;margin:16px 0;font-size:12px;">
          <tr style="background:#2c3e50;color:#fff;">
            <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Phase</th>
            <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Duration</th>
            <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Description</th>
          </tr>
      `;

      timeline.forEach((t, i) => {
        const bgColor = i % 2 === 0 ? 'transparent' : '#f8f9fa';
        const formattedDesc = escapeHtml(t.description || '').replace(/\n/g, '<br>');
        html += `<tr style="background:${bgColor};"><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${escapeHtml(t.phase)}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${escapeHtml(t.duration)}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;white-space:pre-wrap;">${formattedDesc}</td></tr>`;
      });

      html += `
          <tr style="font-weight:600;"><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">Total</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${timelineTotal}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;"></td></tr>
        </table>
        <p style="font-size:11px;color:#7f8c8d;font-style:italic;line-height:1.4;">Please note: We operate in a creative capacity, and project timelines are dependent on the client's cooperation, timely responses, and clear direction on project requirements.</p>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

        <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">What We Need From You</h2>
        <ul style="padding-left:20px;margin:10px 0;">
      `;

      clientNeeds.forEach(need => {
        html += `<li style="margin:6px 0;font-size:13px;">${escapeHtml(need)}</li>`;
      });

      html += `
        </ul>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

        <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Investment</h2>
        <table style="border-collapse:collapse;width:100%;margin:16px 0;font-size:12px;">
          <tr style="background:#2c3e50;color:#fff;">
            <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Milestone</th>
            <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Amount</th>
          </tr>
      `;

      milestones.forEach((m, i) => {
        const bgColor = i % 2 === 0 ? 'transparent' : '#f8f9fa';
        html += `<tr style="background:${bgColor};"><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${escapeHtml(m.name)}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">$${m.amount.toLocaleString()}</td></tr>`;
      });

      html += `
        </table>
        <p style="font-size:13px;font-weight:600;color:#1a1a1a;">Total Investment: $${totalInvestment.toLocaleString()}</p>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

        <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Terms & Conditions</h2>
        <ul style="padding-left:20px;margin:10px 0;">
          <li style="margin:6px 0;font-size:13px;">All content and assets must be provided by client before design phase begins</li>
          <li style="margin:6px 0;font-size:13px;">Revisions are included within each phase; additional rounds may incur extra fees</li>
          <li style="margin:6px 0;font-size:13px;">Timeline begins upon receipt of deposit and required materials</li>
          <li style="margin:6px 0;font-size:13px;">Final files delivered upon receipt of final payment</li>
        </ul>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">
        <p style="font-size:13px;"><strong style="color:#1a1a1a;font-weight:600;">Wenlaunch Studios</strong><br>Mason Price<br>mason@wenlaunch.io</p>
      `;

      return html;
    }

    // Generate PDF from editor content
    function generatePdfFromEditor() {
      const editorContent = document.getElementById('editor-content').innerHTML;
      const clientName = document.getElementById('client_name').value || 'Client';
      const proposalName = document.getElementById('proposal_name').value || 'Proposal';

      // Open in new window for printing
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${proposalName} - ${clientName}</title>
          <style>
            @page {
              margin: 0.5in;
            }
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
              line-height: 1.5;
              color: #2c3e50;
              padding: 40px;
              max-width: 8.5in;
              margin: 0 auto;
              font-size: 13px;
            }
            @media print {
              body { 
                padding: 0;
                margin: 0;
              }
            }
            table { border-collapse: collapse; width: 100%; margin: 16px 0; font-size: 12px; }
            th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; }
            th { background: #2c3e50; color: #fff; font-weight: 600; font-size: 12px; }
            h1 { border-bottom: none; padding-bottom: 8px; color: #1a1a1a; font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
            h2 { margin-top: 28px; margin-bottom: 12px; color: #1a1a1a; font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
            h3 { color: #34495e; font-size: 14px; font-weight: 600; margin-top: 16px; margin-bottom: 8px; }
            p { margin: 10px 0; font-size: 13px; }
            hr { border: none; border-top: 1px solid #e0e0e0; margin: 24px 0; }
            ul { padding-left: 20px; margin: 10px 0; }
            li { margin: 6px 0; font-size: 13px; }
            strong { color: #1a1a1a; font-weight: 600; font-size: 13px; }
            em { font-size: 11px; color: #7f8c8d; }
            .print-btn {
              background: #2c3e50; color: #fff; padding: 12px 24px; border: none;
              border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 20px;
              font-weight: 500;
            }
            .print-btn:hover { background: #34495e; }
            .print-instruction { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; }
            @media print { 
              .print-btn { display: none; }
              .print-instruction { display: none; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" onclick="window.print()">Print / Save as PDF</button>
          <p class="print-instruction">💡 In the print dialog, make sure to disable "Headers and footers" for a clean PDF</p>
          ${editorContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      showStatus('Proposal opened in new tab - click Print or use Cmd/Ctrl+P to save as PDF', 'success');
    }

    // Generate PDF directly from form data (no API needed)
    async function generatePdf() {
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.textContent = 'Generating...';
      showStatus('Generating PDF...', 'loading');

      try {
        // Gather all form data
        const clientName = document.getElementById('client_name').value || 'Client';
        const proposalName = document.getElementById('proposal_name').value || 'Proposal';
        const projectSummary = document.getElementById('project_summary').value || '';
        const timelineTotal = document.getElementById('timeline-total').textContent;

        const deliverables = [];
        document.querySelectorAll('#deliverables-list .list-item').forEach(item => {
          const name = item.querySelector('.deliverable-name').value;
          const desc = item.querySelector('.deliverable-desc').value;
          if (name) deliverables.push({ name, description: desc });
        });

        const timeline = [];
        document.querySelectorAll('#timeline-list .list-item').forEach(item => {
          const phase = item.querySelector('.phase-name').value;
          const num = item.querySelector('.phase-duration-num').value;
          const unit = item.querySelector('.phase-duration-unit').value;
          const desc = item.querySelector('.phase-desc').value;
          if (phase) timeline.push({ phase, duration: `${num} ${unit}`, description: desc });
        });

        const clientNeeds = [];
        document.querySelectorAll('#client-needs-list .client-need').forEach(input => {
          if (input.value.trim()) clientNeeds.push(input.value);
        });

        const milestones = [];
        let totalInvestment = 0;
        document.querySelectorAll('#milestones-list .list-item').forEach(item => {
          const name = item.querySelector('.milestone-name').value;
          const amount = parseFloat(item.querySelector('.milestone-amount').value) || 0;
          if (name) milestones.push({ name, amount });
          totalInvestment += amount;
        });

        const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        // Build HTML directly with logo
        let logoHtml = '';
        if (settings.logo_base64) {
          logoHtml = `<img src="${settings.logo_base64}" style="max-width: 160px; max-height: 70px; object-fit: contain; display: block;">`;
        }
        
        let html = `
          <div style="margin-bottom:25px;border-bottom:1px solid #e0e0e0;padding-bottom:15px;">
            ${logoHtml}
          </div>
          <h1 style="color:#1a1a1a;border-bottom:none;padding-bottom:8px;margin-top:0;font-size:24px;font-weight:600;letter-spacing:-0.5px;">Web Design Proposal</h1>
          <p style="font-size:13px;"><strong style="color:#1a1a1a;font-weight:600;">Client:</strong> ${clientName}<br>
          <strong style="color:#1a1a1a;font-weight:600;">Date:</strong> ${date}<br>
          <strong style="color:#1a1a1a;font-weight:600;">From:</strong> Wenlaunch Studios</p>
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

          <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Project Summary</h2>
          <p style="font-size:13px;line-height:1.5;color:#2c3e50;white-space:pre-wrap;">${escapeHtml(projectSummary || '').replace(/\n/g, '<br>')}</p>
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

          <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Deliverables</h2>
        `;

        deliverables.forEach(d => {
          // Convert bullet points to proper HTML list with nesting
          function formatBulletList(text) {
            if (!text) return '';
            
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return '';
            
            const hasBullets = lines.some(line => /^\s*[-•*]\s/.test(line));
            
            if (!hasBullets) {
              // No bullets, just preserve newlines
              return escapeHtml(text).replace(/\n/g, '<br>');
            }
            
            // Build properly nested HTML list
            const items = lines.map(line => {
              const match = line.match(/^(\s*)([-•*])\s+(.+)$/);
              if (!match) return null;
              const [, indent, , content] = match;
              return {
                level: Math.floor(indent.length / 2),
                content: content.trim()
              };
            }).filter(item => item !== null);
            
            if (items.length === 0) return escapeHtml(text).replace(/\n/g, '<br>');
            
            let html = '<ul style="margin: 10px 0; padding-left: 20px; list-style-type: disc;">';
            const stack = [{ level: 0, isListItem: false }];
            
            items.forEach((item, index) => {
              const { level, content } = item;
              const prevItem = index > 0 ? items[index - 1] : null;
              
              // Close lists/lis when level decreases
              while (stack.length > 1 && stack[stack.length - 1].level >= level) {
                const top = stack[stack.length - 1];
                if (top.isListItem) {
                  html += '</li>';
                  stack.pop();
                }
                if (stack.length > 1 && stack[stack.length - 1].level >= level) {
                  html += '</ul>';
                  stack.pop();
                }
              }
              
              // Open nested list if level increased
              if (prevItem && level > prevItem.level) {
                html += '<ul style="margin: 6px 0; padding-left: 24px; list-style-type: circle;">';
                stack.push({ level, isListItem: false });
              }
              
              // Add list item
              const fontSize = level > 0 ? '12px' : '13px';
              const margin = level > 0 ? '4px' : '6px';
              html += `<li style="margin: ${margin} 0; font-size: ${fontSize};">${escapeHtml(content)}`;
              stack.push({ level, isListItem: true });
              
              // Check if we should close this li (next item is same or less indented)
              const nextItem = items[index + 1];
              if (!nextItem || nextItem.level <= level) {
                html += '</li>';
                stack.pop();
              }
            });
            
            // Close all remaining items
            while (stack.length > 1) {
              const top = stack.pop();
              if (top.isListItem) {
                html += '</li>';
              } else {
                html += '</ul>';
              }
            }
            
            html += '</ul>';
            return html;
          }
          
          const formattedDesc = formatBulletList(d.description || '');
          html += `<h3 style="color:#34495e;font-size:14px;font-weight:600;margin-top:16px;margin-bottom:8px;">${escapeHtml(d.name)}</h3><div style="font-size:13px;line-height:1.5;color:#2c3e50;">${formattedDesc}</div>`;
        });

        html += `
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">
          <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Project Timeline</h2>
          <table style="border-collapse:collapse;width:100%;margin:16px 0;font-size:12px;">
            <tr style="background:#2c3e50;color:#fff;">
              <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Phase</th>
              <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Duration</th>
              <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Description</th>
            </tr>
        `;

        timeline.forEach((t, i) => {
          const bgColor = i % 2 === 0 ? 'transparent' : '#f8f9fa';
          const formattedDesc = escapeHtml(t.description || '').replace(/\n/g, '<br>');
          html += `<tr style="background:${bgColor};"><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${escapeHtml(t.phase)}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${escapeHtml(t.duration)}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;white-space:pre-wrap;">${formattedDesc}</td></tr>`;
        });

        html += `
            <tr style="font-weight:600;"><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">Total</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${timelineTotal}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;"></td></tr>
          </table>
          <p style="font-size:11px;color:#7f8c8d;font-style:italic;line-height:1.4;">Please note: We operate in a creative capacity, and project timelines are dependent on the client's cooperation, timely responses, and clear direction on project requirements.</p>
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

          <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">What We Need From You</h2>
          <ul style="padding-left:20px;margin:10px 0;">
        `;

        clientNeeds.forEach(need => {
          html += `<li style="margin:6px 0;font-size:13px;">${need}</li>`;
        });

        html += `
          </ul>
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

          <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Investment</h2>
          <table style="border-collapse:collapse;width:100%;margin:16px 0;font-size:12px;">
            <tr style="background:#2c3e50;color:#fff;">
              <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Milestone</th>
              <th style="border:1px solid #e0e0e0;padding:10px 12px;text-align:left;font-size:12px;font-weight:600;">Amount</th>
            </tr>
        `;

        milestones.forEach((m, i) => {
          const bgColor = i % 2 === 0 ? 'transparent' : '#f8f9fa';
          html += `<tr style="background:${bgColor};"><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">${m.name}</td><td style="border:1px solid #e0e0e0;padding:10px 12px;font-size:12px;">$${m.amount.toLocaleString()}</td></tr>`;
        });

        html += `
          </table>
          <p style="font-size:13px;font-weight:600;color:#1a1a1a;">Total Investment: $${totalInvestment.toLocaleString()}</p>
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">

          <h2 style="color:#1a1a1a;margin-top:28px;margin-bottom:12px;font-size:17px;font-weight:600;letter-spacing:-0.3px;">Terms & Conditions</h2>
          <ul style="padding-left:20px;margin:10px 0;">
            <li style="margin:6px 0;font-size:13px;">All content and assets must be provided by client before design phase begins</li>
            <li style="margin:6px 0;font-size:13px;">Revisions are included within each phase; additional rounds may incur extra fees</li>
            <li style="margin:6px 0;font-size:13px;">Timeline begins upon receipt of deposit and required materials</li>
            <li style="margin:6px 0;font-size:13px;">Final files delivered upon receipt of final payment</li>
          </ul>
          <hr style="border:none;border-top:1px solid #e0e0e0;margin:24px 0;">
          <p style="font-size:13px;"><strong style="color:#1a1a1a;font-weight:600;">Wenlaunch Studios</strong><br>Mason Price<br>mason@wenlaunch.io</p>
        `;

        // Open in new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>${proposalName} - ${clientName}</title>
            <style>
              @page {
                margin: 0.5in;
              }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
                line-height: 1.5;
                color: #2c3e50;
                padding: 40px;
                max-width: 8.5in;
                margin: 0 auto;
                font-size: 13px;
              }
              @media print {
                body { 
                  padding: 0;
                  margin: 0;
                }
              }
              table { border-collapse: collapse; width: 100%; margin: 16px 0; font-size: 12px; }
              th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; }
              th { background: #2c3e50; color: #fff; font-weight: 600; font-size: 12px; }
              h1 { border-bottom: none; padding-bottom: 8px; color: #1a1a1a; font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
              h2 { margin-top: 28px; margin-bottom: 12px; color: #1a1a1a; font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
              h3 { color: #34495e; font-size: 14px; font-weight: 600; margin-top: 16px; margin-bottom: 8px; }
              p { margin: 10px 0; font-size: 13px; }
              hr { border: none; border-top: 1px solid #e0e0e0; margin: 24px 0; }
              ul { padding-left: 20px; margin: 10px 0; }
              li { margin: 6px 0; font-size: 13px; }
              strong { color: #1a1a1a; font-weight: 600; font-size: 13px; }
              em { font-size: 11px; color: #7f8c8d; }
              .print-btn {
                background: #2c3e50; color: #fff; padding: 12px 24px; border: none;
                border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 20px;
                font-weight: 500;
              }
              .print-btn:hover { background: #34495e; }
              .print-instruction { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; }
              @media print { 
                .print-btn { display: none; }
                .print-instruction { display: none; }
              }
            </style>
          </head>
          <body>
            <button class="print-btn" onclick="window.print()">Print / Save as PDF</button>
            <p class="print-instruction" style="margin-bottom: 20px; color: #7f8c8d; font-size: 12px;">💡 In the print dialog, make sure to disable "Headers and footers" for a clean PDF</p>
            ${html}
          </body>
          </html>
        `);
        printWindow.document.close();

        showStatus('Proposal opened in new tab - click Print or use Cmd/Ctrl+P to save as PDF', 'success');
      } catch (e) {
        showStatus('Error: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate PDF';
      }
    }

    function clearForm() {
      if (!confirm('Clear all form data?')) return;
      document.getElementById('client_name').value = '';
      document.getElementById('proposal_name').value = '';
      document.getElementById('transcript').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('project_summary').value = '';
      document.getElementById('deliverables-list').innerHTML = '';
      document.getElementById('timeline-list').innerHTML = '';
      document.getElementById('client-needs-list').innerHTML = '';
      document.getElementById('milestones-list').innerHTML = '';
      updateTotal();
      
      // Clear saved data and reload defaults
      localStorage.removeItem('proposalFormData');
      addDeliverable();
      addTimelinePhase();
      addClientNeed();
      addMilestone('Upon agreement', '');
      addMilestone('Upon design approval', '');
      addMilestone('Upon completion', '');
    }

    // Generate Email
    function generateEmail() {
      const clientName = document.getElementById('client_name').value || 'there';
      const businessName = 'Wenlaunch Studios';

      // Get deliverables
      const deliverables = [];
      document.querySelectorAll('#deliverables-list .list-item').forEach(item => {
        const name = item.querySelector('.deliverable-name').value;
        if (name) deliverables.push(name);
      });

      // Get timeline total
      const timelineTotal = document.getElementById('timeline-total').textContent;

      // Get total investment
      let totalInvestment = 0;
      document.querySelectorAll('.milestone-amount').forEach(input => {
        totalInvestment += parseFloat(input.value) || 0;
      });

      // Build email
      const email = `Hi ${clientName.split(' ')[0]},

Thank you for taking the time to meet with me to discuss your project. I'm excited about the opportunity to work together!

I've put together a proposal based on our conversation. Here's a quick overview:

Deliverables:
${deliverables.map(d => `• ${d}`).join('\n')}

Timeline: ${timelineTotal}

Investment: $${totalInvestment.toLocaleString()}

I've attached the full proposal with all the details, including the project timeline, what I'll need from you to get started, and payment milestones.

Please take a look and let me know if you have any questions or would like to discuss anything further. I'm happy to hop on a quick call if that's easier.

Looking forward to hearing from you!

Best,
${businessName}`;

      document.getElementById('email-content').textContent = email;
      document.getElementById('email-card').style.display = 'block';
      document.getElementById('email-card').scrollIntoView({ behavior: 'smooth' });
    }

    function copyEmail() {
      const emailText = document.getElementById('email-content').textContent;
      navigator.clipboard.writeText(emailText).then(() => {
        showStatus('Email copied to clipboard!', 'success');
      }).catch(err => {
        showStatus('Failed to copy', 'error');
      });
    }

    // Auto-save functionality
    function saveFormData() {
      const formData = {
        client_name: document.getElementById('client_name').value,
        proposal_name: document.getElementById('proposal_name').value,
        transcript: document.getElementById('transcript').value,
        notes: document.getElementById('notes').value,
        project_summary: document.getElementById('project_summary').value,
        deliverables: [],
        timeline: [],
        client_needs: [],
        milestones: []
      };

      // Save deliverables
      document.querySelectorAll('#deliverables-list .list-item').forEach(item => {
        formData.deliverables.push({
          name: item.querySelector('.deliverable-name').value,
          description: item.querySelector('.deliverable-desc').value
        });
      });

      // Save timeline
      document.querySelectorAll('#timeline-list .list-item').forEach(item => {
        formData.timeline.push({
          phase: item.querySelector('.phase-name').value,
          durationNum: item.querySelector('.phase-duration-num').value,
          durationUnit: item.querySelector('.phase-duration-unit').value,
          description: item.querySelector('.phase-desc').value
        });
      });

      // Save client needs
      document.querySelectorAll('#client-needs-list .client-need').forEach(input => {
        formData.client_needs.push(input.value);
      });

      // Save milestones
      document.querySelectorAll('#milestones-list .list-item').forEach(item => {
        formData.milestones.push({
          name: item.querySelector('.milestone-name').value,
          amount: item.querySelector('.milestone-amount').value
        });
      });

      localStorage.setItem('proposalFormData', JSON.stringify(formData));
    }

    function loadFormData() {
      try {
        const saved = localStorage.getItem('proposalFormData');
        if (!saved) {
          // Add default items if no saved data
          addDeliverable();
          addTimelinePhase();
          addClientNeed();
          addMilestone('Upon agreement', '');
          addMilestone('Upon design approval', '');
          addMilestone('Upon completion', '');
          return;
        }

        const formData = JSON.parse(saved);

        // Load basic fields
        document.getElementById('client_name').value = formData.client_name || '';
        document.getElementById('proposal_name').value = formData.proposal_name || '';
        document.getElementById('transcript').value = formData.transcript || '';
        document.getElementById('notes').value = formData.notes || '';
        document.getElementById('project_summary').value = formData.project_summary || '';

        // Load deliverables
        if (formData.deliverables && formData.deliverables.length > 0) {
          formData.deliverables.forEach(d => addDeliverable(d.name, d.description));
        } else {
          addDeliverable();
        }

        // Load timeline
        if (formData.timeline && formData.timeline.length > 0) {
          formData.timeline.forEach(t => addTimelinePhase(t.phase, t.durationNum, t.durationUnit, t.description));
        } else {
          addTimelinePhase();
        }

        // Load client needs
        if (formData.client_needs && formData.client_needs.length > 0) {
          formData.client_needs.forEach(n => addClientNeed(n));
        } else {
          addClientNeed();
        }

        // Load milestones
        if (formData.milestones && formData.milestones.length > 0) {
          formData.milestones.forEach(m => addMilestone(m.name, m.amount));
        } else {
          addMilestone('Upon agreement', '');
          addMilestone('Upon design approval', '');
          addMilestone('Upon completion', '');
        }

        updateTotal();
        updateTimelineTotal();
      } catch (e) {
        console.error('Failed to load form data:', e);
        // Add default items on error
        addDeliverable();
        addTimelinePhase();
        addClientNeed();
        addMilestone('Upon agreement', '');
        addMilestone('Upon design approval', '');
        addMilestone('Upon completion', '');
      }
    }

    // Auto-save on input changes (debounced)
    let saveTimeout;
    function debouncedSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveFormData, 500); // Save 500ms after user stops typing
    }

    // Add event listeners for auto-save
    function setupAutoSave() {
      // Save on input for text fields
      ['client_name', 'proposal_name', 'transcript', 'notes', 'project_summary'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedSave);
        }
      });

      // Use MutationObserver to detect when list items are added/removed
      const observer = new MutationObserver(debouncedSave);
      ['deliverables-list', 'timeline-list', 'client-needs-list', 'milestones-list'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          observer.observe(element, { childList: true, subtree: true, characterData: true });
        }
      });
    }

    // Tab Switching
    function switchTab(tab) {
      const proposalTab = document.getElementById('proposal-tab');
      const contractTab = document.getElementById('contract-tab');
      const invoiceTab = document.getElementById('invoice-tab');
      const projectMdTab = document.getElementById('project-md-tab');
      const proposalContent = document.getElementById('proposal-content');
      const contractContent = document.getElementById('contract-content');
      const invoiceContent = document.getElementById('invoice-content');
      const projectMdContent = document.getElementById('project-md-content');

      // Remove active from all tabs
      proposalTab.classList.remove('active');
      contractTab.classList.remove('active');
      invoiceTab.classList.remove('active');
      projectMdTab.classList.remove('active');
      
      // Hide all content
      proposalContent.style.display = 'none';
      contractContent.style.display = 'none';
      invoiceContent.style.display = 'none';
      projectMdContent.style.display = 'none';

      if (tab === 'proposal') {
        proposalTab.classList.add('active');
        proposalContent.style.display = 'block';
      } else if (tab === 'contract') {
        contractTab.classList.add('active');
        contractContent.style.display = 'block';
      } else if (tab === 'invoice') {
        invoiceTab.classList.add('active');
        invoiceContent.style.display = 'block';
      } else if (tab === 'project-md') {
        projectMdTab.classList.add('active');
        projectMdContent.style.display = 'block';
      }
    }

    // Contract Agreement Functions
    function formatContractText(command, value = null) {
      document.execCommand(command, false, value);
      document.getElementById('contract-editor-content').focus();
    }

    function showContractEditor() {
      const editorCard = document.getElementById('contract-editor-card');
      const previewBtn = document.getElementById('previewContractBtn');
      const generateBtn = document.getElementById('generateContractBtn');
      
      // Generate contract HTML from form data
      const html = generateContractHtml();
      
      // Populate editor
      document.getElementById('contract-editor-content').innerHTML = html;
      
      // Show editor, hide preview button, show generate button
      editorCard.style.display = 'block';
      previewBtn.style.display = 'none';
      generateBtn.style.display = 'inline-block';
      
      // Scroll to editor
      editorCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function hideContractEditor() {
      const editorCard = document.getElementById('contract-editor-card');
      const previewBtn = document.getElementById('previewContractBtn');
      const generateBtn = document.getElementById('generateContractBtn');
      
      editorCard.style.display = 'none';
      previewBtn.style.display = 'inline-block';
      generateBtn.style.display = 'none';
    }

    // Extract contract body content generation to reusable function
    // This calls generateContract with returnBodyOnly=true to get just the body content
    function generateContractHtml() {
      return generateContract(true);
    }

    // Generate PDF from edited contract content
    function generateContractFromEditor() {
      const editorContent = document.getElementById('contract-editor-content').innerHTML;
      const clientName = document.getElementById('contract_client_name').value || '[Client Name]';
      const proposalName = document.getElementById('contract_project_name').value || 'Contract Agreement';
      const agreementDate = document.getElementById('contract_date').value || new Date().toISOString().split('T')[0];

      // Open in new window for printing with legal document formatting
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Independent Contractor Agreement - ${clientName}</title>
          <style>
            @page {
              margin: 0.5in;
            }
            body {
              font-family: 'Times New Roman', Times, serif;
              line-height: 1.6;
              color: #000;
              padding: 40px;
              max-width: 8.5in;
              margin: 0 auto;
              font-size: 12pt;
            }
            @media print {
              body { 
                padding: 0;
                margin: 0;
              }
            }
            h1 {
              font-size: 18pt;
              font-weight: bold;
              text-align: center;
              margin-bottom: 20px;
            }
            h2 {
              font-size: 14pt;
              font-weight: bold;
              margin-top: 20px;
              margin-bottom: 10px;
            }
            p {
              margin: 10px 0;
              text-align: justify;
            }
            .signature-section {
              margin-top: 40px;
              page-break-inside: avoid;
            }
            .signature-line {
              margin-top: 50px;
              border-top: 1px solid #000;
              padding-top: 5px;
              width: 300px;
            }
            .print-btn {
              background: #2c3e50; color: #fff; padding: 12px 24px; border: none;
              border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 20px;
              font-weight: 500;
            }
            .print-btn:hover { background: #34495e; }
            .print-instruction { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; }
            @media print { 
              .print-btn { display: none; }
              .print-instruction { display: none; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" onclick="window.print()">Print / Save as PDF</button>
          <p class="print-instruction">💡 In the print dialog, make sure to disable "Headers and footers" for a clean PDF</p>
          ${editorContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      showStatus('Contract opened in new tab - click Print or use Cmd/Ctrl+P to save as PDF', 'success');
    }

    function generateContract(returnBodyOnly = false) {
      const clientName = document.getElementById('contract_client_name').value || '[Client Name]';
      const clientEmail = document.getElementById('contract_client_email').value || '[Client Email]';
      const clientAddress = document.getElementById('contract_client_address').value || '[Client Address]';
      const agreementDate = document.getElementById('contract_date').value || new Date().toISOString().split('T')[0];
      const projectName = document.getElementById('contract_project_name').value || '[Project Name]';
      const scope = document.getElementById('contract_scope').value || '[Project Scope]';
      const timeline = document.getElementById('contract_timeline').value || '[Project Timeline]';
      const totalFee = parseFloat(document.getElementById('contract_total_fee').value) || 0;
      const paymentSchedule = document.getElementById('contract_payment_schedule').value || '[Payment Schedule]';
      const workSharing = document.getElementById('contract_work_sharing').checked;
      const confidentiality = document.getElementById('contract_confidentiality').checked;
      const additionalTerms = document.getElementById('contract_additional_terms').value || '';

      const formattedDate = new Date(agreementDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      const formattedFee = totalFee.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

      // Build the body content first (will be used in both editor and PDF)
      const bodyContent = `
          <h1>INDEPENDENT CONTRACTOR AGREEMENT</h1>

          <p>This Independent Contractor Agreement ("Agreement") is entered into on ${formattedDate} ("Effective Date") by and between:</p>

          <p><strong>Contractor:</strong><br>
          MMP Capital LLC<br>
          A Limited Liability Company organized under the laws of the Commonwealth of Virginia<br>
          Business License: Virginia, USA<br>
          (hereinafter referred to as "Contractor")</p>

          <p><strong>Client:</strong><br>
          ${escapeHtml(clientName)}<br>
          ${escapeHtml(clientAddress)}<br>
          Email: ${escapeHtml(clientEmail)}<br>
          (hereinafter referred to as "Client")</p>

          <p>WHEREAS, Contractor is engaged in the business of providing web design and development services; and</p>

          <p>WHEREAS, Client desires to engage Contractor to perform certain services as described herein;</p>

          <p>NOW, THEREFORE, in consideration of the mutual covenants contained herein, the parties agree as follows:</p>

          <h2>1. SCOPE OF WORK</h2>
          <p><strong>1.1 Project Description:</strong> ${escapeHtml(projectName)}</p>
          <p><strong>1.2 Deliverables:</strong> Contractor shall provide the following services and deliverables:</p>
          <p style="margin-left: 20px;">${escapeHtml(scope).replace(/\n/g, '<br>')}</p>
          <p><strong>1.3 Timeline:</strong> ${escapeHtml(timeline)}</p>
          <p><strong>1.4 Timeline as Goal, Not Guarantee:</strong> The timeline specified in Section 1.3 is a goal and estimate based on the information available at the time of execution of this Agreement and assumes timely cooperation and performance by both parties. The timeline is not a guarantee, and Contractor shall not be liable for delays in completion beyond the estimated timeline that result from:</p>
          <ul style="margin-left: 20px;">
            <li>Client's failure to provide required content, materials, information, or approvals in a timely manner;</li>
            <li>Client's requests for changes, revisions, or modifications to the scope of work;</li>
            <li>Client's failure to respond to Contractor's requests for feedback or decisions within reasonable time frames;</li>
            <li>Delays in Third-Party Services, including but not limited to hosting setup, domain registration, or API access;</li>
            <li>Unforeseen technical difficulties or complications that arise during development;</li>
            <li>Acts of God, natural disasters, or other force majeure events;</li>
            <li>Any other circumstances beyond Contractor's reasonable control.</li>
          </ul>
          <p>In the event of delays caused by Client or circumstances beyond Contractor's control, Contractor shall have a reasonable extension of time to complete the work, and the completion date shall be adjusted accordingly. Client acknowledges that delays may occur and agrees not to hold Contractor liable for such delays, provided Contractor continues to work diligently on the project.</p>

          <h2>2. COMPENSATION</h2>
          <p><strong>2.1 Total Fee:</strong> Client agrees to pay Contractor a total fee of ${formattedFee} for the services described herein.</p>
          <p><strong>2.2 Payment Schedule:</strong> Payment shall be made according to the following schedule:</p>
          <p style="margin-left: 20px;">${escapeHtml(paymentSchedule).replace(/\n/g, '<br>')}</p>
          <p><strong>2.3 Payment Method:</strong> Payments shall be made via [Payment Method] to an account designated by Contractor.</p>
          <p><strong>2.4 Late Payment:</strong> Any payment not received within ten (10) business days of the due date shall be subject to a late fee of 5% per month or the maximum allowed by law, whichever is less.</p>
          <p><strong>2.5 Non-Refundable Payments:</strong> All payments made to Contractor are non-refundable based on the phase of work completed. Once a phase has been initiated or completed, payment for that phase is not subject to refund, regardless of whether the project is terminated. Client acknowledges that Contractor incurs costs and allocates resources upon initiation of each phase, and as such, phase payments represent compensation for work performed and resources allocated up to the point of termination, if applicable.</p>

          <h2>3. INDEPENDENT CONTRACTOR STATUS</h2>
          <p>Contractor is an independent contractor, and nothing in this Agreement shall be construed to create an employer-employee relationship, partnership, joint venture, or any other relationship other than that of independent contractor. Contractor shall not be entitled to any employee benefits, and Contractor is responsible for all taxes, insurance, and other obligations related to Contractor's business.</p>

          <h2>4. INTELLECTUAL PROPERTY</h2>
          <p><strong>4.1 Ownership:</strong> Upon full payment of all fees due under this Agreement, Contractor hereby assigns to Client all right, title, and interest in and to the work product created under this Agreement, including but not limited to designs, code, graphics, and other deliverables, to the extent such work product is original and does not incorporate pre-existing materials owned by Contractor or third parties.</p>
          <p><strong>4.2 Contractor's Portfolio Rights:</strong> ${workSharing ? 'Contractor retains the right to use, display, and publish the work product in Contractor\'s portfolio, website, social media, marketing materials, and other promotional materials, with proper attribution to Client. Client grants Contractor a non-exclusive, worldwide, perpetual license to use the work product for such purposes. Contractor agrees to maintain the confidentiality of any proprietary or sensitive business information disclosed by Client, as outlined in Section 5.' : 'Upon full payment, all rights to the work product are assigned to Client as described in Section 4.1. Contractor may not use the work product in its portfolio or marketing materials without Client\'s written consent.'}</p>
          <p><strong>4.3 Third-Party Materials:</strong> Any third-party materials, including fonts, images, plugins, or other assets, shall be subject to their respective licenses, and Client shall be responsible for obtaining any necessary licenses or permissions.</p>

          <h2>5. CONFIDENTIALITY AND PRIVACY</h2>
          <p>${confidentiality ? 'Contractor acknowledges that during the course of performing services under this Agreement, Contractor may have access to confidential, proprietary, or private information belonging to Client, including but not limited to business strategies, financial information, customer data, trade secrets, and other sensitive information ("Confidential Information"). Contractor agrees to:' : 'Contractor shall maintain strict confidentiality of all Client information.'}</p>
          <ul style="margin-left: 20px;">
            ${confidentiality ? `
            <li>Hold all Confidential Information in strict confidence and not disclose it to any third party without Client's prior written consent;</li>
            <li>Use Confidential Information solely for the purpose of performing services under this Agreement;</li>
            <li>Take reasonable measures to protect the confidentiality of such information;</li>
            <li>Return or destroy all Confidential Information upon termination of this Agreement or upon Client's request;</li>
            <li>Not use Confidential Information for Contractor's own benefit or for the benefit of any third party.</li>
            ` : `
            <li>Not disclose any Client information to third parties without written consent;</li>
            <li>Use Client information solely for the purpose of performing services under this Agreement;</li>
            <li>Return or destroy all confidential information upon request.</li>
            `}
          </ul>
          <p>This confidentiality obligation shall survive termination of this Agreement and shall continue indefinitely with respect to trade secrets and for a period of three (3) years with respect to other Confidential Information.</p>

          <h2>6. CLIENT OBLIGATIONS</h2>
          <p>Client agrees to:</p>
          <ul style="margin-left: 20px;">
            <li>Provide all necessary information, content, materials, and access required for Contractor to perform the services;</li>
            <li>Respond to Contractor's requests for feedback, approvals, or information in a timely manner (within [Number] business days, unless otherwise agreed);</li>
            <li>Make payments according to the payment schedule outlined in Section 2.2;</li>
            <li>Obtain any necessary licenses, permissions, or rights for materials provided to Contractor;</li>
            <li>Comply with all applicable laws and regulations in relation to the project.</li>
          </ul>
          <p><strong>6.1 Effect of Client Delays:</strong> Client acknowledges that timely performance of Client's obligations is essential to Contractor's ability to meet the estimated timeline set forth in Section 1.3. Any delays caused by Client's failure to timely perform its obligations under this Section 6, including but not limited to delays in providing content, feedback, or approvals, shall extend the project timeline accordingly and shall not constitute a breach by Contractor. Client shall be responsible for any additional costs or fees resulting from Client-caused delays, including but not limited to rush fees for expedited delivery to meet original deadlines.</p>

          <h2>7. REVISIONS AND CHANGES</h2>
          <p><strong>7.1 Revisions:</strong> Contractor shall provide [Number] rounds of revisions per phase, as outlined in the scope of work. Additional revisions may be requested but shall be subject to additional fees at Contractor's then-current hourly rate.</p>
          <p><strong>7.2 Change Orders:</strong> Any material changes to the scope of work, timeline, or deliverables shall require a written change order signed by both parties. Change orders may result in additional fees and extended timelines.</p>
          <p><strong>7.3 Out-of-Scope Work:</strong> Any work not specifically described in Section 1 (Scope of Work) or any changes requested after approval of deliverables shall be considered out-of-scope and billed separately at Contractor's standard hourly rate of [Rate], with a minimum charge of [Hours] hours per out-of-scope request.</p>
          <p><strong>7.4 Rush Fees:</strong> Requests for expedited delivery or work outside normal business hours may incur rush fees of up to 50% of the applicable project fee or hourly rate, at Contractor's discretion. Rush fees must be agreed upon in writing before work begins.</p>

          <h2>8. ACCEPTANCE AND APPROVAL PROCESS</h2>
          <p><strong>8.1 Delivery and Review:</strong> Contractor shall deliver work product to Client for review and approval. Client shall have [Number] business days from delivery to review and provide feedback or written approval.</p>
          <p><strong>8.2 Deemed Acceptance:</strong> If Client fails to provide written feedback or approval within the review period specified in Section 8.1, the work product shall be deemed accepted and approved by Client.</p>
          <p><strong>8.3 Rejection:</strong> If Client rejects any deliverable, Client must provide written notice specifying the reasons for rejection. Contractor shall have the opportunity to remedy the rejected items in accordance with Section 7.1 (Revisions). Rejection without specific reasons shall not be considered valid rejection.</p>
          <p><strong>8.4 Project Abandonment:</strong> If Client fails to respond to Contractor's communications or requests for feedback for more than [Number] consecutive business days without notice, Contractor may, at its option, deem the project abandoned. In such event, Contractor shall invoice Client for all work completed to date, and Client shall be responsible for payment in accordance with Section 2.5 (Non-Refundable Payments).</p>

          <h2>9. CONTENT AND MATERIALS RESPONSIBILITY</h2>
          <p><strong>9.1 Client Content:</strong> Client is solely responsible for providing all text, images, graphics, videos, logos, trademarks, and other content ("Client Content") required for the project. Client represents and warrants that Client has all necessary rights, licenses, and permissions to use and authorize Contractor to use Client Content.</p>
          <p><strong>9.2 Content Accuracy:</strong> Contractor is not responsible for the accuracy, completeness, or legality of Client Content. Client shall review and approve all Client Content before Contractor incorporates it into the work product. Contractor assumes no liability for errors or omissions in Client Content.</p>
          <p><strong>9.3 Stock Assets:</strong> Any stock photography, fonts, graphics, or other third-party assets required for the project beyond what is included in Contractor's standard toolkit shall be purchased separately by Client, unless otherwise agreed in writing. Client shall reimburse Contractor for any such purchases made on Client's behalf.</p>
          <p><strong>9.4 Content Delays:</strong> Any delays in project delivery resulting from Client's failure to provide required content, feedback, or approvals in a timely manner shall not constitute a breach by Contractor and may result in adjusted timelines or additional fees.</p>

          <h2>10. BROWSER AND DEVICE COMPATIBILITY</h2>
          <p><strong>10.1 Supported Browsers:</strong> Contractor shall design and develop the work product to function properly on current versions of the following browsers: Chrome, Firefox, Safari, and Edge. Support for older browser versions (more than two major versions behind current) is not included unless specifically stated in the Scope of Work.</p>
          <p><strong>10.2 Mobile Compatibility:</strong> The work product shall be responsive and function on current versions of mobile devices and tablets using iOS and Android operating systems. Testing on specific older devices or operating system versions beyond two major versions is not included unless specified.</p>
          <p><strong>10.3 No Guarantee of Compatibility:</strong> Contractor does not guarantee that the work product will function identically or optimally on all browsers, devices, or operating systems. Client acknowledges that web technologies evolve, and differences in rendering are inherent to web development.</p>
          <p><strong>10.4 Testing Responsibility:</strong> While Contractor shall test the work product on the browsers and devices specified, Client is responsible for testing the final work product in their intended use environment. Contractor shall address legitimate bugs or compatibility issues that arise during the warranty period as outlined in Section 13 (Warranty).</p>

          <h2>11. THIRD-PARTY DEPENDENCIES AND SERVICES</h2>
          <p><strong>11.1 Third-Party Services:</strong> The work product may depend on or integrate with third-party services, including but not limited to hosting providers, content management systems (CMS), payment processors, analytics services, APIs, plugins, and other external services ("Third-Party Services").</p>
          <p><strong>11.2 Client Responsibility:</strong> Client is responsible for selecting, purchasing, and maintaining accounts for Third-Party Services. Contractor is not responsible for the availability, performance, pricing, terms of service, or any changes to Third-Party Services. Client acknowledges that Third-Party Services may change, discontinue, or modify their services, which may affect the work product.</p>
          <p><strong>11.3 Hosting:</strong> Unless otherwise specified in the Scope of Work, Client is responsible for procuring and maintaining web hosting services. Contractor shall provide technical specifications for hosting requirements. Contractor is not responsible for hosting-related issues, including but not limited to downtime, slow performance, or security breaches related to hosting.</p>
          <p><strong>11.4 Domain Names:</strong> Client is solely responsible for registering, renewing, and maintaining domain names. Contractor is not responsible for domain registration, renewal, or any issues related to domain management.</p>
          <p><strong>11.5 Third-Party Licenses:</strong> Any software licenses, plugin licenses, theme licenses, or other third-party licenses required for the project shall be obtained and maintained by Client unless otherwise specified. Contractor may recommend Third-Party Services but makes no warranties regarding their suitability or ongoing availability.</p>
          <p><strong>11.6 Third-Party Indemnification:</strong> Client agrees to indemnify and hold Contractor harmless from any claims, damages, or liabilities arising from Client's use of Third-Party Services or from changes, discontinuation, or modification of Third-Party Services.</p>

          <h2>12. SEARCH ENGINE OPTIMIZATION (SEO)</h2>
          <p><strong>12.1 SEO Services:</strong> Unless specifically included in the Scope of Work, SEO services, including but not limited to keyword research, link building, content optimization, and ongoing SEO monitoring, are not included in this Agreement.</p>
          <p><strong>12.2 No SEO Guarantees:</strong> Contractor makes no guarantees or warranties regarding search engine rankings, search engine visibility, organic traffic, or any other SEO-related metrics. SEO results depend on numerous factors outside Contractor's control, including search engine algorithms, competitor activities, and market conditions.</p>
          <p><strong>12.3 SEO Best Practices:</strong> If SEO is included in the Scope of Work, Contractor shall implement SEO best practices in the work product, including semantic HTML structure, meta tags, and other on-page optimization techniques, but does not guarantee specific rankings or traffic results.</p>

          <h2>13. WARRANTY AND POST-LAUNCH SUPPORT</h2>
          <p><strong>13.1 Limited Warranty - Post-Launch Bug Fixes:</strong> Contractor warrants that the work product will substantially conform to the specifications set forth in the Scope of Work. Contractor shall provide post-launch support for bug fixes on active pages that were worked on under the scope of this project for a period of thirty (30) days from the date of final acceptance ("Warranty Period"). This warranty covers only bug fixes on active pages created or modified under the scope of work and does not cover:</p>
          <ul style="margin-left: 20px;">
            <li>New features, functionality, or pages not included in the original Scope of Work;</li>
            <li>Client's modifications to the work product;</li>
            <li>Misuse, abuse, or unauthorized alterations of the work product;</li>
            <li>Issues with Third-Party Services or hosting;</li>
            <li>Browser or device compatibility issues beyond those specified in Section 10;</li>
            <li>Issues resulting from Client Content or third-party code;</li>
            <li>Changes in web technologies, browsers, or standards after delivery;</li>
            <li>Content updates, security patches, or ongoing maintenance;</li>
            <li>Issues on pages or functionality that were not part of the original project scope.</li>
          </ul>
          <p><strong>13.2 Warranty Remedies:</strong> Contractor's sole obligation during the 30-day Warranty Period shall be to correct bugs on active pages that were created or modified under the scope of this project and that are reported in writing by Client within the Warranty Period. Contractor shall use reasonable efforts to correct such bugs within a reasonable time frame. This warranty applies only to active, live pages that were part of the original project deliverables.</p>
          <p><strong>13.3 Post-Launch Support:</strong> The 30-day warranty period described in Section 13.1 covers only bug fixes on active pages within the project scope. After the Warranty Period expires, all support, including ongoing maintenance, updates, bug fixes, content updates, security patches, new features, and technical support, are not included in this Agreement and may be provided under a separate maintenance or support agreement for additional fees.</p>
          <p><strong>13.4 Security:</strong> While Contractor shall implement reasonable security measures during development, Contractor does not guarantee that the work product will be free from security vulnerabilities. Client is responsible for implementing and maintaining appropriate security measures, including regular backups, security monitoring, and keeping software and plugins updated.</p>
          <p><strong>13.5 Backups:</strong> Client is solely responsible for maintaining backups of the work product and all associated data. Contractor is not responsible for data loss, corruption, or unavailability. Contractor recommends that Client maintain regular, automated backups.</p>

          <h2>14. INDEMNIFICATION</h2>
          <p><strong>14.1 Client Indemnification:</strong> Client agrees to indemnify, defend, and hold harmless Contractor and its officers, directors, employees, and agents from and against any and all claims, damages, losses, liabilities, costs, and expenses (including reasonable attorneys' fees) arising out of or relating to:</p>
          <ul style="margin-left: 20px;">
            <li>Client's use of the work product;</li>
            <li>Client Content, including claims that Client Content infringes the intellectual property or other rights of any third party;</li>
            <li>Client's breach of this Agreement;</li>
            <li>Claims arising from Third-Party Services;</li>
            <li>Client's modifications to the work product;</li>
            <li>Claims related to Client's business operations, products, or services.</li>
          </ul>
          <p><strong>14.2 Contractor Indemnification:</strong> Contractor agrees to indemnify, defend, and hold harmless Client from and against any claims that the work product (excluding Client Content and Third-Party Services) infringes the intellectual property rights of any third party, provided that Client promptly notifies Contractor of such claim, gives Contractor sole control of the defense and settlement, and provides reasonable assistance in the defense.</p>
          <p><strong>14.3 Indemnification Exceptions:</strong> Contractor's indemnification obligation shall not apply to claims arising from: (a) Client Content; (b) modifications to the work product not made by Contractor; (c) use of the work product in combination with products or services not provided by Contractor; (d) Client's continued use of the work product after Contractor has notified Client of a potential infringement; or (e) Third-Party Services.</p>

          <h2>15. WARRANTIES AND REPRESENTATIONS</h2>
          <p><strong>15.1 Contractor Warranties:</strong> Contractor represents and warrants that:</p>
          <ul style="margin-left: 20px;">
            <li>Contractor has the right and authority to enter into this Agreement and perform the services described herein;</li>
            <li>The work product will be original to Contractor or properly licensed from third parties;</li>
            <li>The work product (excluding Client Content and Third-Party Services) will not infringe upon the intellectual property rights of any third party;</li>
            <li>Contractor will perform the services in a professional and workmanlike manner in accordance with industry standards.</li>
          </ul>
          <p><strong>15.2 Client Warranties:</strong> Client represents and warrants that:</p>
          <ul style="margin-left: 20px;">
            <li>Client has the right and authority to enter into this Agreement;</li>
            <li>Client Content does not infringe upon the intellectual property or other rights of any third party;</li>
            <li>Client has all necessary rights, licenses, and permissions to use and authorize Contractor to use Client Content;</li>
            <li>All information provided to Contractor is accurate and complete to the best of Client's knowledge.</li>
          </ul>
          <p><strong>15.3 Disclaimers:</strong> EXCEPT AS EXPRESSLY PROVIDED HEREIN, CONTRACTOR MAKES NO OTHER WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, NON-INFRINGEMENT, OR THAT THE WORK PRODUCT WILL MEET CLIENT'S SPECIFIC REQUIREMENTS OR EXPECTATIONS. CONTRACTOR DOES NOT WARRANT THAT THE WORK PRODUCT WILL BE ERROR-FREE, UNINTERRUPTED, SECURE, OR FREE FROM VIRUSES OR OTHER HARMFUL COMPONENTS.</p>

          <h2>16. LIMITATION OF LIABILITY</h2>
          <p>IN NO EVENT SHALL CONTRACTOR BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, INCLUDING BUT NOT LIMITED TO LOSS OF PROFITS, REVENUE, DATA, OR USE, ARISING OUT OF OR RELATED TO THIS AGREEMENT, REGARDLESS OF THE THEORY OF LIABILITY. CONTRACTOR'S TOTAL LIABILITY UNDER THIS AGREEMENT SHALL NOT EXCEED THE TOTAL AMOUNT PAID BY CLIENT TO CONTRACTOR UNDER THIS AGREEMENT.</p>

          <h2>17. TERMINATION</h2>
          <p><strong>17.1 Termination for Convenience:</strong> Either party may terminate this Agreement at any time upon thirty (30) days' written notice to the other party. Upon termination, Client shall pay Contractor for all work completed up to the date of termination, calculated based on the payment schedule and phase completion.</p>
          <p><strong>17.2 Termination for Cause:</strong> Either party may terminate this Agreement immediately upon written notice if the other party breaches any material term of this Agreement and fails to cure such breach within ten (10) days of receiving written notice of the breach.</p>
          <p><strong>17.3 Effect of Termination:</strong> Upon termination, Contractor shall deliver to Client all work product completed up to the date of termination, and Client shall pay all fees owed to Contractor for work performed up to the date of termination. Sections 4, 5, 14, 15, 16, and 18 shall survive termination.</p>

          <h2>18. DISPUTE RESOLUTION</h2>
          <p><strong>18.1 Governing Law:</strong> This Agreement shall be governed by and construed in accordance with the laws of the Commonwealth of Virginia, without regard to its conflict of law principles.</p>
          <p><strong>18.2 Jurisdiction:</strong> Any disputes arising out of or related to this Agreement shall be subject to the exclusive jurisdiction of the state and federal courts located in Virginia.</p>
          <p><strong>18.3 Mediation:</strong> Before initiating any legal proceedings, the parties agree to attempt to resolve any disputes through good faith negotiation and, if necessary, mediation with a mutually agreed mediator.</p>

          <h2>19. GENERAL PROVISIONS</h2>
          <p><strong>12.1 Entire Agreement:</strong> This Agreement constitutes the entire agreement between the parties and supersedes all prior agreements, understandings, or communications relating to the subject matter hereof.</p>
          <p><strong>12.2 Modifications:</strong> This Agreement may only be modified in writing and signed by both parties.</p>
          <p><strong>12.3 Severability:</strong> If any provision of this Agreement is found to be invalid or unenforceable, the remaining provisions shall continue in full force and effect.</p>
          <p><strong>12.4 Waiver:</strong> The failure of either party to enforce any provision of this Agreement shall not constitute a waiver of such provision or any other provision.</p>
          <p><strong>12.5 Notices:</strong> All notices required under this Agreement shall be in writing and delivered via email or certified mail to the addresses specified at the beginning of this Agreement.</p>
          <p><strong>12.6 Assignment:</strong> Neither party may assign this Agreement without the prior written consent of the other party, except that Contractor may assign this Agreement to an affiliate or successor entity.</p>
          <p><strong>12.7 Force Majeure:</strong> Neither party shall be liable for any failure or delay in performance due to circumstances beyond its reasonable control, including but not limited to acts of God, natural disasters, war, terrorism, or government actions.</p>
          ${additionalTerms ? `
          <h2>20. ADDITIONAL TERMS</h2>
          <p>${escapeHtml(additionalTerms).replace(/\n/g, '<br>')}</p>
          ` : ''}

          <div class="signature-section">
            <p>IN WITNESS WHEREOF, the parties have executed this Agreement as of the date first written above.</p>

            <div style="margin-top: 40px; display: flex; justify-content: space-between;">
              <div>
                <div class="signature-line">
                  <strong>CONTRACTOR:</strong><br>
                  MMP Capital LLC<br><br>
                  ___________________________<br>
                  Signature<br><br>
                  ___________________________<br>
                  Print Name<br><br>
                  ___________________________<br>
                  Date
                </div>
              </div>

              <div>
                <div class="signature-line">
                  <strong>CLIENT:</strong><br>
                  ${escapeHtml(clientName)}<br><br>
                  ___________________________<br>
                  Signature<br><br>
                  ___________________________<br>
                  Print Name<br><br>
                  ___________________________<br>
                  Date
                </div>
              </div>
            </div>
          </div>

          <p style="margin-top: 40px; font-size: 10pt; color: #666; text-align: center;">
            <em>This is a legal document. Please review carefully and consult with an attorney if you have any questions.</em>
          </p>
      `;

      // If only body content requested (for editor), return it
      if (returnBodyOnly) {
        return bodyContent;
      }

      // Otherwise, wrap in full HTML document and open window
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Independent Contractor Agreement - ${clientName}</title>
          <style>
            @page {
              margin: 0.5in;
            }
            body {
              font-family: 'Times New Roman', serif;
              line-height: 1.6;
              color: #000;
              padding: 40px;
              max-width: 8.5in;
              margin: 0 auto;
              font-size: 12pt;
            }
            @media print {
              body { 
                padding: 0;
                margin: 0;
              }
            }
            h1 {
              font-size: 18pt;
              font-weight: bold;
              text-align: center;
              margin-bottom: 20px;
            }
            h2 {
              font-size: 14pt;
              font-weight: bold;
              margin-top: 20px;
              margin-bottom: 10px;
            }
            p {
              margin: 10px 0;
              text-align: justify;
            }
            .signature-section {
              margin-top: 40px;
              page-break-inside: avoid;
            }
            .signature-line {
              margin-top: 50px;
              border-top: 1px solid #000;
              padding-top: 5px;
              width: 300px;
            }
            .print-btn {
              background: #2c3e50; color: #fff; padding: 12px 24px; border: none;
              border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 20px;
              font-weight: 500;
            }
            .print-btn:hover { background: #34495e; }
            .print-instruction { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; }
            @media print { 
              .print-btn { display: none; }
              .print-instruction { display: none; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" onclick="window.print()">Print / Save as PDF</button>
          <p class="print-instruction">💡 In the print dialog, make sure to disable "Headers and footers" for a clean PDF</p>
          ${bodyContent}
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      showStatus('Contract opened in new tab - click Print or use Cmd/Ctrl+P to save as PDF', 'success');
    }

    // Contract form auto-save functionality
    function saveContractFormData() {
      const contractData = {
        client_name: document.getElementById('contract_client_name').value,
        client_email: document.getElementById('contract_client_email').value,
        client_address: document.getElementById('contract_client_address').value,
        contract_date: document.getElementById('contract_date').value,
        project_name: document.getElementById('contract_project_name').value,
        scope: document.getElementById('contract_scope').value,
        timeline: document.getElementById('contract_timeline').value,
        total_fee: document.getElementById('contract_total_fee').value,
        payment_schedule: document.getElementById('contract_payment_schedule').value,
        work_sharing: document.getElementById('contract_work_sharing').checked,
        confidentiality: document.getElementById('contract_confidentiality').checked,
        additional_terms: document.getElementById('contract_additional_terms').value
      };

      localStorage.setItem('contractFormData', JSON.stringify(contractData));
    }

    function loadContractFormData() {
      try {
        const saved = localStorage.getItem('contractFormData');
        if (!saved) {
          // Set default date if no saved data
          document.getElementById('contract_date').value = new Date().toISOString().split('T')[0];
          return;
        }

        const contractData = JSON.parse(saved);

        // Load all fields
        document.getElementById('contract_client_name').value = contractData.client_name || '';
        document.getElementById('contract_client_email').value = contractData.client_email || '';
        document.getElementById('contract_client_address').value = contractData.client_address || '';
        document.getElementById('contract_date').value = contractData.contract_date || new Date().toISOString().split('T')[0];
        document.getElementById('contract_project_name').value = contractData.project_name || '';
        document.getElementById('contract_scope').value = contractData.scope || '';
        document.getElementById('contract_timeline').value = contractData.timeline || '';
        document.getElementById('contract_total_fee').value = contractData.total_fee || '';
        document.getElementById('contract_payment_schedule').value = contractData.payment_schedule || '';
        document.getElementById('contract_work_sharing').checked = contractData.work_sharing !== undefined ? contractData.work_sharing : true;
        document.getElementById('contract_confidentiality').checked = contractData.confidentiality !== undefined ? contractData.confidentiality : true;
        document.getElementById('contract_additional_terms').value = contractData.additional_terms || '';
      } catch (e) {
        console.error('Failed to load contract form data:', e);
        // Set default date on error
        document.getElementById('contract_date').value = new Date().toISOString().split('T')[0];
      }
    }

    // Auto-save contract form on input changes (debounced)
    let saveContractTimeout;
    function debouncedSaveContract() {
      clearTimeout(saveContractTimeout);
      saveContractTimeout = setTimeout(saveContractFormData, 500);
    }

    // Setup auto-save listeners for contract form
    function setupContractAutoSave() {
      const contractFields = [
        'contract_client_name',
        'contract_client_email',
        'contract_client_address',
        'contract_date',
        'contract_project_name',
        'contract_scope',
        'contract_timeline',
        'contract_total_fee',
        'contract_payment_schedule',
        'contract_additional_terms'
      ];

      contractFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedSaveContract);
          element.addEventListener('change', debouncedSaveContract);
        }
      });

      // Checkboxes
      ['contract_work_sharing', 'contract_confidentiality'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', debouncedSaveContract);
        }
      });
    }

    function clearContractForm() {
      if (!confirm('Clear all contract form data?')) return;
      document.getElementById('contract_client_name').value = '';
      document.getElementById('contract_client_email').value = '';
      document.getElementById('contract_client_address').value = '';
      document.getElementById('contract_date').value = new Date().toISOString().split('T')[0];
      document.getElementById('contract_project_name').value = '';
      document.getElementById('contract_scope').value = '';
      document.getElementById('contract_timeline').value = '';
      document.getElementById('contract_total_fee').value = '';
      document.getElementById('contract_payment_schedule').value = '';
      document.getElementById('contract_work_sharing').checked = true;
      document.getElementById('contract_confidentiality').checked = true;
      document.getElementById('contract_additional_terms').value = '';
      
      // Clear saved data
      localStorage.removeItem('contractFormData');
    }

    // Invoice Functions
    function addInvoiceItem() {
      const list = document.getElementById('invoice-items-list');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'list-item';
      itemDiv.innerHTML = `
        <div class="row" style="gap: 12px; align-items: end;">
          <div style="flex: 3;">
            <label>Description</label>
            <input type="text" class="invoice-item-desc" placeholder="Service or item description" oninput="calculateInvoiceTotal(); debouncedSaveInvoice();">
          </div>
          <div style="flex: 1;">
            <label>Quantity</label>
            <input type="number" class="invoice-item-qty" step="1" min="0" value="1" oninput="calculateInvoiceTotal(); debouncedSaveInvoice();">
          </div>
          <div style="flex: 1;">
            <label>Rate ($)</label>
            <input type="number" class="invoice-item-rate" step="0.01" min="0" value="0.00" oninput="calculateInvoiceTotal(); debouncedSaveInvoice();">
          </div>
          <div style="flex: 1;">
            <label>Amount ($)</label>
            <input type="text" class="invoice-item-amount" readonly value="0.00" style="background: #2a2a2a; color: #999;">
          </div>
          <div style="flex: 0 0 auto;">
            <button class="btn btn-danger" onclick="removeInvoiceItem(this)" style="padding: 8px 12px;">Remove</button>
          </div>
        </div>
      `;
      list.appendChild(itemDiv);
      calculateInvoiceTotal();
    }

    function removeInvoiceItem(btn) {
      btn.closest('.list-item').remove();
      calculateInvoiceTotal();
      debouncedSaveInvoice();
    }

    function calculateInvoiceTotal() {
      const items = document.querySelectorAll('#invoice-items-list .list-item');
      let subtotal = 0;

      items.forEach(item => {
        const qty = parseFloat(item.querySelector('.invoice-item-qty').value) || 0;
        const rate = parseFloat(item.querySelector('.invoice-item-rate').value) || 0;
        const amount = qty * rate;
        item.querySelector('.invoice-item-amount').value = amount.toFixed(2);
        subtotal += amount;
      });

      const taxRate = parseFloat(document.getElementById('invoice_tax_rate').value) || 0;
      const tax = (subtotal * taxRate) / 100;
      const total = subtotal + tax;

      document.getElementById('invoice_subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('invoice_tax').textContent = tax.toFixed(2);
      document.getElementById('invoice_total').textContent = total.toFixed(2);
    }

    function generateInvoice() {
      const invoiceNumber = document.getElementById('invoice_number').value || 'INV-001';
      const invoiceDate = document.getElementById('invoice_date').value || new Date().toISOString().split('T')[0];
      const dueDate = document.getElementById('invoice_due_date').value || '';
      const clientName = document.getElementById('invoice_client_name').value || 'Client';
      const clientEmail = document.getElementById('invoice_client_email').value || '';
      const clientAddress = document.getElementById('invoice_client_address').value || '';
      const notes = document.getElementById('invoice_notes').value || '';
      const subtotal = parseFloat(document.getElementById('invoice_subtotal').textContent) || 0;
      const tax = parseFloat(document.getElementById('invoice_tax').textContent) || 0;
      const total = parseFloat(document.getElementById('invoice_total').textContent) || 0;
      const taxRate = parseFloat(document.getElementById('invoice_tax_rate').value) || 0;

      // Get Bill From info (use form fields if filled, otherwise fall back to settings)
      const billFromName = document.getElementById('invoice_bill_from_name').value || settings.business_name || 'Wenlaunch Studios';
      const billFromEmail = document.getElementById('invoice_bill_from_email').value || settings.business_email || 'mason@wenlaunch.io';
      const billFromPhone = document.getElementById('invoice_bill_from_phone').value || settings.business_phone || '';
      const billFromAddress = document.getElementById('invoice_bill_from_address').value || '';
      const logoBase64 = settings.logo_base64 || '';

      // Get bank details from settings
      const bankName = settings.bank_name || 'JP Morgan Chase';
      const bankAccount = settings.bank_account || '687043015';
      const bankRouting = settings.bank_routing || '044000037';
      const bankAccountName = settings.bank_account_name || 'MMP Capital LLC';
      const bankAddress = settings.bank_address || '40638 Grenata Preserve Place, Leesburg Virginia 20175 United States';

      // Build line items HTML
      let lineItemsHtml = '';
      const items = document.querySelectorAll('#invoice-items-list .list-item');
      items.forEach(item => {
        const desc = item.querySelector('.invoice-item-desc').value || '';
        const qty = item.querySelector('.invoice-item-qty').value || '0';
        const rate = item.querySelector('.invoice-item-rate').value || '0.00';
        const amount = item.querySelector('.invoice-item-amount').value || '0.00';
        if (desc) {
          lineItemsHtml += `
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${desc}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center;">${qty}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: right;">$${parseFloat(rate).toFixed(2)}</td>
              <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: right;">$${parseFloat(amount).toFixed(2)}</td>
            </tr>
          `;
        }
      });

      if (!lineItemsHtml) {
        showStatus('Please add at least one line item', 'error');
        return;
      }

      // Format dates
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      };

      const logoHtml = logoBase64 ? `<img src="${logoBase64}" alt="Logo" style="max-width: 180px; max-height: 70px; margin-bottom: 10px; display: block;">` : '';

      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice ${invoiceNumber} - ${clientName}</title>
          <style>
            @page { margin: 0.4in; }
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
              font-size: 12px;
              line-height: 1.4;
              color: #1a1a1a;
              background: #fff;
              padding: 0;
              margin: 0;
            }
            .header {
              margin-bottom: 20px;
            }
            .invoice-title {
              font-size: 28px;
              font-weight: 700;
              color: #1a1a1a;
              margin: 0 0 15px 0;
              letter-spacing: -1px;
            }
            .info-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 20px;
              margin-bottom: 20px;
            }
            .info-section h3 {
              font-size: 12px;
              font-weight: 600;
              color: #1a1a1a;
              margin: 0 0 6px 0;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            .info-section p {
              margin: 2px 0;
              color: #555;
              font-size: 12px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 15px;
            }
            th {
              background: #f5f5f5;
              padding: 8px;
              text-align: left;
              font-weight: 600;
              color: #1a1a1a;
              font-size: 11px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              border-bottom: 2px solid #ddd;
            }
            th:nth-child(2),
            th:nth-child(3),
            th:nth-child(4) {
              text-align: right;
            }
            td {
              padding: 8px;
              border-bottom: 1px solid #e0e0e0;
              font-size: 12px;
            }
            .totals {
              margin-top: 10px;
              margin-left: auto;
              width: 280px;
            }
            .totals-row {
              display: flex;
              justify-content: space-between;
              padding: 4px 0;
              font-size: 12px;
            }
            .totals-row.total-row {
              border-top: 2px solid #1a1a1a;
              margin-top: 6px;
              padding-top: 8px;
              font-size: 16px;
              font-weight: 600;
            }
            .notes {
              margin-top: 20px;
              padding-top: 10px;
              border-top: 1px solid #e0e0e0;
            }
            .notes h3 {
              font-size: 12px;
              font-weight: 600;
              color: #1a1a1a;
              margin: 0 0 6px 0;
            }
            .notes p {
              color: #555;
              font-size: 11px;
              white-space: pre-wrap;
              margin: 2px 0;
              line-height: 1.4;
            }
            @media print {
              .print-btn { display: none; }
              .print-instruction { display: none; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" onclick="window.print()" style="background: #2c3e50; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 20px; font-weight: 500;">Print / Save as PDF</button>
          <p class="print-instruction" style="color: #7f8c8d; font-size: 12px; margin-bottom: 20px;">💡 In the print dialog, make sure to disable "Headers and footers" for a clean PDF</p>
          
          <div class="header">
            ${logoHtml}
            <h1 class="invoice-title">INVOICE</h1>
          </div>

          <div class="info-grid">
            <div class="info-section">
              <h3>Bill From</h3>
              <p><strong>${billFromName}</strong></p>
              ${billFromEmail ? `<p>${billFromEmail}</p>` : ''}
              ${billFromPhone ? `<p>${billFromPhone}</p>` : ''}
              ${billFromAddress ? `<p style="white-space: pre-line; margin-top: 8px;">${billFromAddress}</p>` : ''}
            </div>
            <div class="info-section">
              <h3>Bill To</h3>
              <p><strong>${clientName}</strong></p>
              ${clientEmail ? `<p>${clientEmail}</p>` : ''}
              ${clientAddress ? `<p style="white-space: pre-line;">${clientAddress}</p>` : ''}
            </div>
          </div>

          <div class="info-grid" style="margin-bottom: 15px;">
            <div class="info-section">
              <p><strong>Invoice Number:</strong> ${invoiceNumber}</p>
              <p><strong>Invoice Date:</strong> ${formatDate(invoiceDate)}</p>
              ${dueDate ? `<p><strong>Due Date:</strong> ${formatDate(dueDate)}</p>` : ''}
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="text-align: right;">Quantity</th>
                <th style="text-align: right;">Rate</th>
                <th style="text-align: right;">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${lineItemsHtml}
            </tbody>
          </table>

          <div class="totals" style="margin-left: auto; width: 300px;">
            <div class="totals-row">
              <span>Subtotal:</span>
              <span>$${subtotal.toFixed(2)}</span>
            </div>
            ${taxRate > 0 ? `
            <div class="totals-row">
              <span>Tax (${taxRate}%):</span>
              <span>$${tax.toFixed(2)}</span>
            </div>
            ` : ''}
            <div class="totals-row total-row">
              <span>Total:</span>
              <span>$${total.toFixed(2)}</span>
            </div>
          </div>

          <div class="notes">
            <h3>Bank Transfer Details</h3>
            <p>
              <strong>Bank Name:</strong> ${bankName}<br>
              <strong>Account No:</strong> ${bankAccount}<br>
              <strong>Routing No (Wire Transfer):</strong> ${bankRouting}<br>
              <strong>Account Name:</strong> ${bankAccountName}<br>
              <strong>Address:</strong> ${bankAddress}
            </p>
          </div>

          ${notes ? `
          <div class="notes">
            <h3>Notes</h3>
            <p>${notes}</p>
          </div>
          ` : ''}
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
      showStatus('Invoice opened in new tab - click Print or use Cmd/Ctrl+P to save as PDF', 'success');
    }

    // Invoice form auto-save functionality
    function saveInvoiceFormData() {
      const invoiceItems = [];
      document.querySelectorAll('#invoice-items-list .list-item').forEach(item => {
        invoiceItems.push({
          desc: item.querySelector('.invoice-item-desc').value || '',
          qty: item.querySelector('.invoice-item-qty').value || '1',
          rate: item.querySelector('.invoice-item-rate').value || '0.00'
        });
      });

      const invoiceData = {
        invoice_number: document.getElementById('invoice_number').value,
        invoice_date: document.getElementById('invoice_date').value,
        invoice_due_date: document.getElementById('invoice_due_date').value,
        bill_from_name: document.getElementById('invoice_bill_from_name').value,
        bill_from_email: document.getElementById('invoice_bill_from_email').value,
        bill_from_phone: document.getElementById('invoice_bill_from_phone').value,
        bill_from_address: document.getElementById('invoice_bill_from_address').value,
        client_name: document.getElementById('invoice_client_name').value,
        client_email: document.getElementById('invoice_client_email').value,
        client_address: document.getElementById('invoice_client_address').value,
        tax_rate: document.getElementById('invoice_tax_rate').value,
        notes: document.getElementById('invoice_notes').value,
        items: invoiceItems
      };

      localStorage.setItem('invoiceFormData', JSON.stringify(invoiceData));
    }

    function loadInvoiceFormData() {
      try {
        const saved = localStorage.getItem('invoiceFormData');
        if (!saved) {
          // Set default date if no saved data
          document.getElementById('invoice_date').value = new Date().toISOString().split('T')[0];
          // Add one default item
          addInvoiceItem();
          return;
        }

        const invoiceData = JSON.parse(saved);

        // Load all fields
        document.getElementById('invoice_number').value = invoiceData.invoice_number || '';
        document.getElementById('invoice_date').value = invoiceData.invoice_date || new Date().toISOString().split('T')[0];
        document.getElementById('invoice_due_date').value = invoiceData.invoice_due_date || '';
        document.getElementById('invoice_bill_from_name').value = invoiceData.bill_from_name || '';
        document.getElementById('invoice_bill_from_email').value = invoiceData.bill_from_email || '';
        document.getElementById('invoice_bill_from_phone').value = invoiceData.bill_from_phone || '';
        document.getElementById('invoice_bill_from_address').value = invoiceData.bill_from_address || '';
        document.getElementById('invoice_client_name').value = invoiceData.client_name || '';
        document.getElementById('invoice_client_email').value = invoiceData.client_email || '';
        document.getElementById('invoice_client_address').value = invoiceData.client_address || '';
        document.getElementById('invoice_tax_rate').value = invoiceData.tax_rate || '0';
        document.getElementById('invoice_notes').value = invoiceData.notes || '';

        // Clear existing items first
        document.getElementById('invoice-items-list').innerHTML = '';
        
        // Load items
        if (invoiceData.items && invoiceData.items.length > 0) {
          invoiceData.items.forEach(item => {
            addInvoiceItem();
            const listItems = document.querySelectorAll('#invoice-items-list .list-item');
            const lastItem = listItems[listItems.length - 1];
            lastItem.querySelector('.invoice-item-desc').value = item.desc || '';
            lastItem.querySelector('.invoice-item-qty').value = item.qty || '1';
            lastItem.querySelector('.invoice-item-rate').value = item.rate || '0.00';
          });
        } else {
          addInvoiceItem();
        }

        calculateInvoiceTotal();
      } catch (e) {
        console.error('Failed to load invoice form data:', e);
        // Set default date on error
        document.getElementById('invoice_date').value = new Date().toISOString().split('T')[0];
        addInvoiceItem();
      }
    }

    // Auto-save invoice form on input changes (debounced)
    let saveInvoiceTimeout;
    function debouncedSaveInvoice() {
      clearTimeout(saveInvoiceTimeout);
      saveInvoiceTimeout = setTimeout(saveInvoiceFormData, 500);
    }

    // Setup auto-save listeners for invoice form
    function setupInvoiceAutoSave() {
      const invoiceFields = [
        'invoice_number',
        'invoice_date',
        'invoice_due_date',
        'invoice_bill_from_name',
        'invoice_bill_from_email',
        'invoice_bill_from_phone',
        'invoice_bill_from_address',
        'invoice_client_name',
        'invoice_client_email',
        'invoice_client_address',
        'invoice_tax_rate',
        'invoice_notes'
      ];

      invoiceFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedSaveInvoice);
          element.addEventListener('change', debouncedSaveInvoice);
        }
      });
    }

    function clearInvoiceForm() {
      if (!confirm('Clear all invoice form data?')) return;
      document.getElementById('invoice_number').value = '';
      document.getElementById('invoice_date').value = new Date().toISOString().split('T')[0];
      document.getElementById('invoice_due_date').value = '';
      document.getElementById('invoice_bill_from_name').value = '';
      document.getElementById('invoice_bill_from_email').value = '';
      document.getElementById('invoice_bill_from_phone').value = '';
      document.getElementById('invoice_bill_from_address').value = '';
      document.getElementById('invoice_client_name').value = '';
      document.getElementById('invoice_client_email').value = '';
      document.getElementById('invoice_client_address').value = '';
      document.getElementById('invoice_tax_rate').value = '0';
      document.getElementById('invoice_notes').value = '';
      document.getElementById('invoice-items-list').innerHTML = '';
      
      // Clear saved data
      localStorage.removeItem('invoiceFormData');
      
      // Add one default item
      addInvoiceItem();
    }

    // Project MD File Functions
    function generateProjectMD() {
      const projectName = document.getElementById('project_md_name').value || 'Untitled Project';
      const projectNiche = document.getElementById('project_md_niche').value || '';
      const companyName = document.getElementById('project_md_company_name').value || '';
      const industry = document.getElementById('project_md_industry').value || '';
      const companyDescription = document.getElementById('project_md_company_description').value || '';
      const targetAudience = document.getElementById('project_md_target_audience').value || '';
      const conversation = document.getElementById('project_md_conversation').value || '';
      const websiteUrl = document.getElementById('project_md_website_url').value || '';
      const referenceLinks = document.getElementById('project_md_reference_links').value || '';
      const goals = document.getElementById('project_md_goals').value || '';
      const requirements = document.getElementById('project_md_requirements').value || '';
      const techStack = document.getElementById('project_md_tech_stack').value || '';
      const timeline = document.getElementById('project_md_timeline').value || '';
      const notes = document.getElementById('project_md_notes').value || '';

      // Generate markdown content
      let markdown = `# ${projectName}\n\n`;

      if (projectNiche) {
        markdown += `## Project Niche\n${projectNiche}\n\n`;
      }

      markdown += `## Company Details\n\n`;
      if (companyName) {
        markdown += `**Company Name:** ${companyName}\n\n`;
      }
      if (industry) {
        markdown += `**Industry / Sector:** ${industry}\n\n`;
      }
      if (companyDescription) {
        markdown += `**Company Description:**\n${companyDescription}\n\n`;
      }
      if (targetAudience) {
        markdown += `**Target Audience:**\n${targetAudience}\n\n`;
      }

      if (websiteUrl) {
        markdown += `**Website URL:** ${websiteUrl}\n\n`;
      }

      if (referenceLinks) {
        markdown += `## Reference Site Links\n\n`;
        const links = referenceLinks.split('\n').filter(link => link.trim());
        links.forEach(link => {
          const trimmed = link.trim();
          markdown += `- ${trimmed}\n`;
        });
        markdown += `\n`;
      }

      if (goals) {
        markdown += `## Project Goals / Objectives\n\n${goals}\n\n`;
      }

      if (requirements) {
        markdown += `## Key Requirements / Deliverables\n\n${requirements}\n\n`;
      }

      if (techStack) {
        markdown += `## Technology Stack\n${techStack}\n\n`;
      }

      if (timeline) {
        markdown += `## Timeline / Important Dates\n\n${timeline}\n\n`;
      }

      if (conversation) {
        markdown += `## Client Conversation / Requirements\n\n${conversation}\n\n`;
      }

      if (notes) {
        markdown += `## Additional Notes\n\n${notes}\n\n`;
      }

      // Create a blob and download
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${projectName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showStatus('Markdown file downloaded!', 'success');
    }

    // Project MD form auto-save functionality
    function saveProjectMDFormData() {
      const projectMDData = {
        project_name: document.getElementById('project_md_name').value,
        project_niche: document.getElementById('project_md_niche').value,
        company_name: document.getElementById('project_md_company_name').value,
        industry: document.getElementById('project_md_industry').value,
        company_description: document.getElementById('project_md_company_description').value,
        target_audience: document.getElementById('project_md_target_audience').value,
        conversation: document.getElementById('project_md_conversation').value,
        website_url: document.getElementById('project_md_website_url').value,
        reference_links: document.getElementById('project_md_reference_links').value,
        goals: document.getElementById('project_md_goals').value,
        requirements: document.getElementById('project_md_requirements').value,
        tech_stack: document.getElementById('project_md_tech_stack').value,
        timeline: document.getElementById('project_md_timeline').value,
        notes: document.getElementById('project_md_notes').value
      };

      localStorage.setItem('projectMDFormData', JSON.stringify(projectMDData));
    }

    function loadProjectMDFormData() {
      try {
        const saved = localStorage.getItem('projectMDFormData');
        if (!saved) {
          return;
        }

        const projectMDData = JSON.parse(saved);

        // Load all fields
        document.getElementById('project_md_name').value = projectMDData.project_name || '';
        document.getElementById('project_md_niche').value = projectMDData.project_niche || '';
        document.getElementById('project_md_company_name').value = projectMDData.company_name || '';
        document.getElementById('project_md_industry').value = projectMDData.industry || '';
        document.getElementById('project_md_company_description').value = projectMDData.company_description || '';
        document.getElementById('project_md_target_audience').value = projectMDData.target_audience || '';
        document.getElementById('project_md_conversation').value = projectMDData.conversation || '';
        document.getElementById('project_md_website_url').value = projectMDData.website_url || '';
        document.getElementById('project_md_reference_links').value = projectMDData.reference_links || '';
        document.getElementById('project_md_goals').value = projectMDData.goals || '';
        document.getElementById('project_md_requirements').value = projectMDData.requirements || '';
        document.getElementById('project_md_tech_stack').value = projectMDData.tech_stack || '';
        document.getElementById('project_md_timeline').value = projectMDData.timeline || '';
        document.getElementById('project_md_notes').value = projectMDData.notes || '';
      } catch (e) {
        console.error('Failed to load project MD form data:', e);
      }
    }

    // Auto-save project MD form on input changes (debounced)
    let saveProjectMDTimeout;
    function debouncedSaveProjectMD() {
      clearTimeout(saveProjectMDTimeout);
      saveProjectMDTimeout = setTimeout(saveProjectMDFormData, 500);
    }

    // Setup auto-save listeners for project MD form
    function setupProjectMDAutoSave() {
      const projectMDFields = [
        'project_md_name',
        'project_md_niche',
        'project_md_company_name',
        'project_md_industry',
        'project_md_company_description',
        'project_md_target_audience',
        'project_md_conversation',
        'project_md_website_url',
        'project_md_reference_links',
        'project_md_goals',
        'project_md_requirements',
        'project_md_tech_stack',
        'project_md_timeline',
        'project_md_notes'
      ];

      projectMDFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', debouncedSaveProjectMD);
          element.addEventListener('change', debouncedSaveProjectMD);
        }
      });
    }

    function clearProjectMDForm() {
      if (!confirm('Clear all project MD form data?')) return;
      document.getElementById('project_md_name').value = '';
      document.getElementById('project_md_niche').value = '';
      document.getElementById('project_md_company_name').value = '';
      document.getElementById('project_md_industry').value = '';
      document.getElementById('project_md_company_description').value = '';
      document.getElementById('project_md_target_audience').value = '';
      document.getElementById('project_md_conversation').value = '';
      document.getElementById('project_md_website_url').value = '';
      document.getElementById('project_md_reference_links').value = '';
      document.getElementById('project_md_goals').value = '';
      document.getElementById('project_md_requirements').value = '';
      document.getElementById('project_md_tech_stack').value = '';
      document.getElementById('project_md_timeline').value = '';
      document.getElementById('project_md_notes').value = '';
      
      // Clear saved data
      localStorage.removeItem('projectMDFormData');
    }

    // Initialize
    loadSettings();
    loadFormData(); // Load saved proposal form data
    setupAutoSave(); // Setup proposal auto-save listeners
    loadContractFormData(); // Load saved contract form data
    setupContractAutoSave(); // Setup contract auto-save listeners
    loadInvoiceFormData(); // Load saved invoice form data
    setupInvoiceAutoSave(); // Setup invoice auto-save listeners
    loadProjectMDFormData(); // Load saved project MD form data
    setupProjectMDAutoSave(); // Setup project MD auto-save listeners
  </script>
</body>
</html>
